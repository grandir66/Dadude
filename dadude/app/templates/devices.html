{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Dispositivi</h1>
        <p class="text-muted mb-0" id="device-count">{{ devices|length }} dispositivi totali</p>
    </div>
    <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="statusFilter" id="filter-all" value="" {% if not status_filter %}checked{% endif %} v-on:change="filterByStatus('')">
        <label class="btn btn-outline-secondary" for="filter-all">Tutti</label>
        
        <input type="radio" class="btn-check" name="statusFilter" id="filter-up" value="up" {% if status_filter == 'up' %}checked{% endif %} v-on:change="filterByStatus('up')">
        <label class="btn btn-outline-success" for="filter-up">UP</label>
        
        <input type="radio" class="btn-check" name="statusFilter" id="filter-down" value="down" {% if status_filter == 'down' %}checked{% endif %} v-on:change="filterByStatus('down')">
        <label class="btn btn-outline-danger" for="filter-down">DOWN</label>
    </div>
</div>

<!-- Vue DataTable per Dispositivi -->
<div id="devices-app">
    <data-table
        :data="filteredDevices"
        :columns="columns"
        :searchable="true"
        :sortable="true"
        :paginated="true"
        :items-per-page="15"
        empty-message="Nessun dispositivo trovato"
    >
        <template #cell-status="{ value }">
            <span v-if="value === 'up'" class="badge bg-success">
                <i class="bi bi-check-circle"></i> UP
            </span>
            <span v-else-if="value === 'down'" class="badge bg-danger">
                <i class="bi bi-x-circle"></i> DOWN
            </span>
            <span v-else class="badge bg-secondary">
                <i class="bi bi-question-circle"></i> <span v-text="value ? value.toUpperCase() : 'UNKNOWN'"></span>
            </span>
        </template>
        
        <template #cell-name="{ value }">
            <strong v-text="value"></strong>
        </template>
        
        <template #cell-address="{ value }">
            <code v-text="value || '-'"></code>
        </template>
        
        <template #cell-mac_address="{ value }">
            <code class="text-muted" v-text="value || '-'"></code>
        </template>
        
        <template #cell-last_seen="{ value }">
            <span v-if="value" v-text="formatDate(value)"></span>
            <span v-else>-</span>
        </template>
    </data-table>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dati devices passati dal server
const devicesData = {{ devices | tojson }};
const statusFilter = {{ status_filter | tojson if status_filter else 'null' }};

// App Vue per devices
const { createApp } = Vue;

createApp({
    data() {
        return {
            devices: devicesData,
            currentStatusFilter: statusFilter || '',
            columns: [
                { key: 'status', label: 'Stato', field: (row) => row.status?.value || 'unknown', sortable: true },
                { key: 'name', label: 'Nome', field: 'name', sortable: true },
                { key: 'address', label: 'Indirizzo IP', field: 'address', sortable: true },
                { key: 'mac_address', label: 'MAC Address', field: 'mac_address', sortable: true },
                { key: 'device_type', label: 'Tipo', field: 'device_type', sortable: true },
                { key: 'group', label: 'Gruppo', field: 'group', sortable: true },
                { key: 'last_seen', label: 'Ultimo Contatto', field: 'last_seen', sortable: true }
            ]
        }
    },
    computed: {
        filteredDevices() {
            if (!this.currentStatusFilter) {
                return this.devices;
            }
            return this.devices.filter(device => {
                const status = device.status?.value || 'unknown';
                return status === this.currentStatusFilter;
            });
        }
    },
    mounted() {
        this.updateDeviceCount();
    },
    methods: {
        filterByStatus(status) {
            this.currentStatusFilter = status;
            // Aggiorna URL senza ricaricare la pagina
            const url = new URL(window.location);
            if (status) {
                url.searchParams.set('status', status);
            } else {
                url.searchParams.delete('status');
            }
            window.history.pushState({}, '', url);
            this.updateDeviceCount();
        },
        formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            } catch (e) {
                return dateString;
            }
        },
        updateDeviceCount() {
            const countEl = document.getElementById('device-count');
            if (countEl) {
                const total = this.filteredDevices.length;
                const totalAll = this.devices.length;
                if (this.currentStatusFilter) {
                    countEl.textContent = `${total} dispositivi (${totalAll} totali)`;
                } else {
                    countEl.textContent = `${totalAll} dispositivi totali`;
                }
            }
        }
    },
    watch: {
        filteredDevices() {
            this.updateDeviceCount();
        }
    }
}).mount('#devices-app');
</script>
{% endblock %}
