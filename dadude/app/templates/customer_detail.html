{% extends "base.html" %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/customers">Clienti</a></li>
                <li class="breadcrumb-item active">{{ customer.code }}</li>
            </ol>
        </nav>
        <h1 class="h3 mb-0">{{ customer.name }}</h1>
    </div>
    <div>
        <a href="/customers/{{ customer.id }}/discovery" class="btn btn-primary">
            <i class="bi bi-search"></i> Discovery
        </a>
        <a href="/api/v1/import-export/customers/{{ customer.id }}/networks/csv" class="btn btn-outline-secondary">
            <i class="bi bi-download"></i> Export Reti
        </a>
        <a href="/api/v1/import-export/customers/{{ customer.id }}/credentials/csv" class="btn btn-outline-secondary">
            <i class="bi bi-download"></i> Export Credenziali
        </a>
    </div>
</div>

<!-- Info Cliente -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Informazioni Cliente
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Codice:</strong> <code>{{ customer.code }}</code></p>
                        <p><strong>Nome:</strong> {{ customer.name }}</p>
                        <p><strong>Descrizione:</strong> {{ customer.description or '-' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Contatto:</strong> {{ customer.contact_name or '-' }}</p>
                        <p><strong>Email:</strong> {{ customer.contact_email or '-' }}</p>
                        <p><strong>Telefono:</strong> {{ customer.contact_phone or '-' }}</p>
                    </div>
                </div>
                {% if customer.address %}
                <p><strong>Indirizzo:</strong> {{ customer.address }}</p>
                {% endif %}
                {% if customer.notes %}
                <p><strong>Note:</strong> {{ customer.notes }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Riepilogo
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Reti configurate:</span>
                    <strong>{{ networks|length }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Credenziali:</span>
                    <strong>{{ credentials|length }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Device assegnati:</span>
                    <strong>{{ devices|length }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="customerTabs">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#networks">
            <i class="bi bi-diagram-3"></i> Reti ({{ networks|length }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#credentials">
            <i class="bi bi-key"></i> Credenziali ({{ credentials|length }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#agents">
            <i class="bi bi-broadcast"></i> Sonde ({{ agents|length if agents else 0 }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#scans" onclick="loadScans()">
            <i class="bi bi-search"></i> Scansioni
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#inventory" onclick="loadInventory()">
            <i class="bi bi-hdd-network"></i> Inventario <span id="inventoryCount" class="badge bg-secondary">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#duplicates" onclick="loadDuplicates()">
            <i class="bi bi-files"></i> Duplicati <span id="duplicatesCount" class="badge bg-warning">0</span>
        </a>
    </li>
</ul>

<div class="tab-content">
    <!-- Tab Reti -->
    <div class="tab-pane fade show active" id="networks">
        <div class="d-flex justify-content-between mb-3">
            <h5>Reti IP / VLAN</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newNetworkModal">
                <i class="bi bi-plus"></i> Nuova Rete
            </button>
        </div>
        <div class="card table-modern">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Network</th>
                        <th>Gateway</th>
                        <th>VLAN</th>
                        <th>ARP Source</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for net in networks %}
                    <tr>
                        <td><strong>{{ net.name }}</strong></td>
                        <td><span class="badge bg-secondary">{{ net.network_type }}</span></td>
                        <td><code>{{ net.ip_network }}</code></td>
                        <td><code>{{ net.gateway or '-' }}</code></td>
                        <td>
                            {% if net.vlan_id %}
                            <span class="badge bg-info">{{ net.vlan_id }}</span>
                            {{ net.vlan_name or '' }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if net.gateway_agent_id %}
                            <span class="badge bg-primary" title="MikroTik API"><i class="bi bi-router"></i> MikroTik</span>
                            {% elif net.gateway_snmp_address %}
                            <span class="badge bg-warning text-dark" title="SNMP: {{ net.gateway_snmp_address }}"><i class="bi bi-broadcast"></i> SNMP</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if net.active %}
                            <span class="badge bg-success">Attiva</span>
                            {% else %}
                            <span class="badge bg-secondary">Inattiva</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" 
                                        onclick="editNetwork({
                                            id: '{{ net.id }}',
                                            name: '{{ net.name | e }}',
                                            network_type: '{{ net.network_type or 'lan' }}',
                                            ip_network: '{{ net.ip_network }}',
                                            gateway: '{{ net.gateway or '' }}',
                                            vlan_id: {{ net.vlan_id or 'null' }},
                                            dns_primary: '{{ net.dns_primary or '' }}',
                                            active: {{ 'true' if net.active else 'false' }},
                                            description: '{{ (net.description or '') | e }}',
                                            gateway_agent_id: '{{ net.gateway_agent_id or '' }}',
                                            gateway_snmp_address: '{{ net.gateway_snmp_address or '' }}',
                                            gateway_snmp_community: '{{ net.gateway_snmp_community or '' }}',
                                            gateway_snmp_version: '{{ net.gateway_snmp_version or '2c' }}'
                                        })"
                                        title="Modifica rete">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-primary" 
                                        onclick="configureGateway('{{ net.id }}', '{{ net.name }}', '{{ net.gateway_agent_id or '' }}', '{{ net.gateway_snmp_address or '' }}', '{{ net.gateway_snmp_community or '' }}', '{{ net.gateway_snmp_version or '2c' }}')"
                                        title="Gateway ARP">
                                    <i class="bi bi-diagram-3"></i>
                                </button>
                                <button class="btn btn-outline-danger" 
                                        onclick="deleteNetwork('{{ net.id }}', '{{ net.name }}')"
                                        title="Elimina rete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" class="text-center py-4 text-muted">Nessuna rete configurata</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Credenziali -->
    <div class="tab-pane fade" id="credentials">
        <div class="d-flex justify-content-between mb-3">
            <h5>Credenziali Assegnate</h5>
            <div>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assignCredentialModal">
                    <i class="bi bi-link"></i> Assegna Esistente
                </button>
                <a href="/settings/credentials" class="btn btn-outline-secondary btn-sm" title="Gestisci tutte le credenziali">
                    <i class="bi bi-gear"></i> Gestione Credenziali
                </a>
            </div>
        </div>
        <div class="card table-modern">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Username</th>
                        <th>Dettagli</th>
                        <th>Default</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cred in credentials %}
                    <tr>
                        <td><strong>{{ cred.name }}</strong></td>
                        <td><span class="badge bg-{{ 'success' if cred.credential_type == 'ssh' else 'info' if cred.credential_type == 'snmp' else 'warning' if cred.credential_type == 'wmi' else 'danger' if cred.credential_type == 'mikrotik' else 'primary' }}">{{ cred.credential_type }}</span></td>
                        <td>{{ cred.username or '-' }}</td>
                        <td class="small text-muted">
                            {% if cred.credential_type == 'ssh' %}
                                Port {{ cred.ssh_port or 22 }}{% if cred.has_ssh_key %} üîë{% endif %}
                            {% elif cred.credential_type == 'snmp' %}
                                v{{ cred.snmp_version or '2c' }} {{ cred.snmp_community or '' }}
                            {% elif cred.credential_type == 'wmi' %}
                                {{ cred.wmi_domain or 'LOCAL' }}
                            {% elif cred.credential_type == 'mikrotik' %}
                                Port {{ cred.mikrotik_api_port or 8728 }}{% if cred.mikrotik_api_ssl %} SSL{% endif %}
                            {% else %}
                                {{ cred.device_filter or '-' }}
                            {% endif %}
                        </td>
                        <td>
                            {% if cred.is_default %}
                            <span class="badge bg-warning text-dark">Default</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if cred.active %}
                            <span class="badge bg-success">Attiva</span>
                            {% else %}
                            <span class="badge bg-secondary">Inattiva</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="testCredential('{{ cred.id }}', '{{ cred.name }}', '{{ cred.credential_type }}')" title="Verifica stato">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="unlinkCredential('{{ cred.id }}', '{{ cred.name }}')" title="Rimuovi dal cliente">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" class="text-center py-4 text-muted">Nessuna credenziale configurata</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Sonde -->
    <div class="tab-pane fade" id="agents">
        <div class="d-flex justify-content-between mb-3">
            <h5>Sonde Assegnate</h5>
            <a href="/agents" class="btn btn-outline-secondary btn-sm" title="Gestisci tutte le sonde">
                <i class="bi bi-gear"></i> Gestione Sonde
            </a>
        </div>
        <div class="card table-modern">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Indirizzo</th>
                        <th>Sede</th>
                        <th>Stato</th>
                        <th>Ultima Conn.</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agent in agents %}
                    <tr>
                        <td>
                            <strong>{{ agent.name }}</strong>
                            {% if agent.version %}
                            <br><small class="text-muted">v{{ agent.version }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set agent_type = agent.agent_type if agent.agent_type else 'mikrotik' %}
                            {% if agent_type == 'docker' %}
                            <span class="badge bg-info">
                                <i class="bi bi-box"></i> Docker
                            </span>
                            {% else %}
                            <span class="badge bg-primary">
                                <i class="bi bi-router"></i> MikroTik
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <code>{{ agent.address }}</code>
                            <br>
                            <small class="text-muted">
                                {% set agent_type = agent.agent_type if agent.agent_type else 'mikrotik' %}
                                {% if agent_type == 'docker' %}
                                <i class="bi bi-globe"></i> API:{{ agent.agent_api_port if agent.agent_api_port else 8080 }}
                                {% elif agent.connection_type == 'api' %}
                                <i class="bi bi-hdd-network"></i> API:{{ agent.port }}
                                {% elif agent.connection_type == 'ssh' %}
                                <i class="bi bi-terminal"></i> SSH:{{ agent.ssh_port }}
                                {% else %}
                                <i class="bi bi-hdd-network"></i> API:{{ agent.port }} 
                                <i class="bi bi-terminal"></i> SSH:{{ agent.ssh_port }}
                                {% endif %}
                                {% if agent.dns_server %}
                                <br><i class="bi bi-server"></i> DNS: {{ agent.dns_server }}
                                {% endif %}
                            </small>
                        </td>
                        <td>{{ agent.site_name or agent.location or '-' }}</td>
                        <td>
                            {% if agent.status == 'online' %}
                            <span class="badge bg-success"><i class="bi bi-wifi"></i> Online</span>
                            {% if agent.ws_connected %}
                            <small class="text-success d-block"><i class="bi bi-broadcast"></i> WebSocket</small>
                            {% endif %}
                            {% elif agent.status == 'reachable' %}
                            <span class="badge bg-info"><i class="bi bi-arrow-right-circle"></i> Raggiungibile</span>
                            {% if agent.reachable_via %}
                            <small class="text-muted d-block">via {{ agent.reachable_via }}</small>
                            {% endif %}
                            {% elif agent.status == 'unreachable' %}
                            <span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Non raggiungibile</span>
                            {% elif agent.status == 'offline' %}
                            <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Offline</span>
                            {% elif agent.status == 'partial' %}
                            <span class="badge bg-warning">Parziale</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ agent.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ agent.last_seen.strftime('%d/%m %H:%M') if agent.last_seen else '-' }}</td>
                        <td>
                            {% set agent_type = agent.agent_type if agent.agent_type else 'mikrotik' %}
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-secondary" onclick="editAgent('{{ agent.id }}')" title="Modifica sonda">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="testAgent('{{ agent.id }}')" title="Test connessione">
                                    <i class="bi bi-wifi"></i>
                                </button>
                                {% if agent_type == 'mikrotik' %}
                                <a href="/customers/{{ customer.id }}/agents/{{ agent.id }}/mikrotik" class="btn btn-outline-info" title="Gestione MikroTik">
                                    <i class="bi bi-router"></i>
                                </a>
                                {% endif %}
                                <button class="btn btn-outline-danger" onclick="unlinkAgent('{{ agent.id }}', '{{ agent.name }}')" title="Rimuovi dal cliente">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" class="text-center py-4 text-muted">Nessuna sonda configurata</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Scansioni -->
    <div class="tab-pane fade" id="scans">
        <!-- Card Discovery -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-search me-2"></i>Discovery & Import Dispositivi</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Rete da scansionare</label>
                        <select class="form-select" id="discoveryNetwork">
                            <option value="">-- Seleziona rete --</option>
                            {% for net in networks %}
                            <option value="{{ net.id }}" data-cidr="{{ net.ip_network }}">{{ net.name }} ({{ net.ip_network }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Sonda</label>
                        <select class="form-select" id="discoveryAgent">
                            <option value="">-- Seleziona sonda --</option>
                            {% for agent in agents %}
                            {% set agent_type = agent.agent_type if agent.agent_type else 'mikrotik' %}
                            <option value="{{ agent.id }}" data-agent-type="{{ agent_type }}">
                                {% if agent_type == 'docker' %}üê≥{% else %}üì°{% endif %}
                                {{ agent.name }} ({{ agent.address }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="runCustomerDiscovery()">
                            <i class="bi bi-search me-1"></i>Scansiona
                        </button>
                    </div>
                </div>
                
                <!-- Risultati Discovery -->
                <div id="discoverySection" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <span id="discoveryDeviceCount">0</span> dispositivi trovati
                            <span id="discoveryIdentifiedBadge" class="badge bg-success ms-2" style="display: none;">0 identificati</span>
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" onclick="identifyDiscoveredDevices()">
                                <i class="bi bi-cpu me-1"></i>Identifica
                            </button>
                            <button class="btn btn-outline-primary" onclick="selectAllDiscovered()">
                                <i class="bi bi-check-all"></i>
                            </button>
                            <button class="btn btn-success" onclick="importDiscoveredDevices()">
                                <i class="bi bi-download me-1"></i>Importa
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow: auto;">
                        <table class="table table-sm table-hover mb-0" style="min-width: 900px;">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th width="30"><input type="checkbox" id="selectAllDiscoveredCb" onchange="toggleAllDiscovered()"></th>
                                    <th width="120">IP</th>
                                    <th width="140">MAC</th>
                                    <th width="100">Vendor</th>
                                    <th width="100">Tipo</th>
                                    <th width="110">Credenziali</th>
                                    <th width="150">Hostname</th>
                                    <th width="200">Servizi</th>
                                    <th width="150">Stato</th>
                                </tr>
                            </thead>
                            <tbody id="discoveryResultsBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="discoveryLoading" class="text-center py-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    <span id="discoveryLoadingText">Scansione in corso...</span>
                </div>
            </div>
        </div>
        
        <!-- Card Scansioni di Rete -->
        <div class="card mb-4 mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-task me-2"></i>Scansioni di Rete</h6>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-danger" onclick="cleanupOldScans()" title="Elimina scansioni vecchie">
                        <i class="bi bi-trash"></i> Pulisci Vecchie
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadScans()">
                        <i class="bi bi-arrow-clockwise"></i> Aggiorna
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Rete</th>
                                <th>Tipo</th>
                                <th>Stato</th>
                                <th>Device Trovati</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="scansTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Caricamento scansioni...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab Inventario -->
    <div class="tab-pane fade" id="inventory">
        <!-- Card Inventario Esistente -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-collection me-2"></i>Dispositivi Inventariati</h6>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="inventoryTypeFilter" onchange="loadInventory()">
                        <option value="">Tutti i tipi</option>
                        <option value="mikrotik">MikroTik</option>
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                        <option value="network">Apparati Rete</option>
                        <option value="printer">Stampanti</option>
                        <option value="camera">Telecamere</option>
                        <option value="voip">VoIP</option>
                        <option value="other">Altri</option>
                    </select>
                    <button class="btn btn-warning btn-sm me-2" onclick="batchAutoDetect()" title="Auto-detect su tutti i dispositivi (usa credenziali default + porte rilevate)">
                        <i class="bi bi-bullseye"></i> Auto-Detect
                    </button>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="batchScanPorts()" title="Scansiona porte di tutti i dispositivi">
                        <i class="bi bi-router"></i> Scansiona Porte
                    </button>
                    <button class="btn btn-outline-danger btn-sm me-2" onclick="clearInventory()" title="Svuota inventario">
                        <i class="bi bi-trash"></i> Svuota
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadInventory()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="inventoryLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table table-hover mb-0" id="inventoryTable" style="min-width: 1400px;">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(0, 'text')">
                                    Nome <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(1, 'ip')">
                                    IP <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(2, 'text')">
                                    MAC <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(3, 'text')">
                                    Tipo <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(4, 'text')">
                                    Categoria <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(5, 'text')">
                                    OS <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortInventoryTable(6, 'text')">
                                    Vendor <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>
                                <th>Servizi</th>
                                <th>Credenziali</th>
                                <th>Monitoraggio</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <tr><td colspan="11" class="text-center py-4 text-muted">Clicca su "Dispositivi" per caricare i dati</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab Device Duplicati -->
    <div class="tab-pane fade" id="duplicates">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-files me-2"></i>Device Duplicati</h6>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadDuplicates()">
                        <i class="bi bi-arrow-clockwise"></i> Aggiorna
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="duplicatesLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
                <div id="duplicatesContent">
                    <p class="text-muted text-center py-4">Clicca su "Duplicati" per caricare i dati</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuova Rete -->
<div class="modal fade" id="newNetworkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuova Rete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newNetworkForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-control" name="name" required placeholder="LAN Uffici">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" name="network_type">
                                <option value="lan">LAN</option>
                                <option value="wan">WAN</option>
                                <option value="dmz">DMZ</option>
                                <option value="guest">Guest</option>
                                <option value="management">Management</option>
                                <option value="voip">VoIP</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">VLAN ID</label>
                            <input type="number" class="form-control" name="vlan_id" min="1" max="4094">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Network CIDR *</label>
                        <input type="text" class="form-control" name="ip_network" required placeholder="192.168.1.0/24">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gateway</label>
                            <input type="text" class="form-control" name="gateway" placeholder="192.168.1.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DNS Primario</label>
                            <input type="text" class="form-control" name="dns_primary" placeholder="8.8.8.8">
                        </div>
                    </div>
                    
                    <!-- Gateway per ARP Lookup (reti remote) -->
                    <hr class="my-3">
                    <h6 class="text-muted mb-3"><i class="bi bi-diagram-3"></i> Gateway ARP (per reti remote)</h6>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Gateway MikroTik</label>
                            <select class="form-select" name="gateway_agent_id" id="gatewayAgentId">
                                <option value="">-- Nessuno (usa SNMP o fallback) --</option>
                                {% for agent in agents %}
                                {% if agent.agent_type == 'mikrotik' %}
                                <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.address }})</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <small class="text-muted">Seleziona un router MikroTik per leggere la tabella ARP</small>
                        </div>
                    </div>
                    <div class="row" id="snmpGatewayFields">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Gateway SNMP (alternativo)</label>
                            <input type="text" class="form-control" name="gateway_snmp_address" placeholder="192.168.1.1">
                            <small class="text-muted">IP router Cisco/Ubiquiti/HP</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Community</label>
                            <input type="text" class="form-control" name="gateway_snmp_community" placeholder="public">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Versione SNMP</label>
                            <select class="form-select" name="gateway_snmp_version">
                                <option value="2c">v2c</option>
                                <option value="1">v1</option>
                                <option value="3">v3</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Rete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Configura Gateway ARP -->
<div class="modal fade" id="gatewayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-diagram-3"></i> Configura Gateway ARP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="gatewayForm">
                <input type="hidden" name="network_id" id="gw_network_id">
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        <strong id="gw_network_name"></strong><br>
                        <small>Configura come recuperare la tabella ARP per questa rete.</small>
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Metodo</label>
                        <select class="form-select" id="gw_method" onchange="toggleGatewayFields()">
                            <option value="none">Nessuno (fallback automatico)</option>
                            <option value="mikrotik">MikroTik API</option>
                            <option value="snmp">SNMP generico</option>
                        </select>
                    </div>
                    
                    <div id="gw_mikrotik_fields" style="display:none;">
                        <label class="form-label">Router MikroTik</label>
                        <select class="form-select" id="gw_agent_id">
                            <option value="">-- Seleziona --</option>
                            {% for agent in agents %}
                            {% if agent.agent_type == 'mikrotik' %}
                            <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.address }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="gw_snmp_fields" style="display:none;">
                        <div class="mb-2">
                            <label class="form-label">IP Router</label>
                            <input type="text" class="form-control" id="gw_snmp_address" placeholder="192.168.1.1">
                        </div>
                        <div class="row">
                            <div class="col-8 mb-2">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" id="gw_snmp_community" placeholder="public">
                            </div>
                            <div class="col-4 mb-2">
                                <label class="form-label">Versione</label>
                                <select class="form-select" id="gw_snmp_version">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifica Rete -->
<div class="modal fade" id="editNetworkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Modifica Rete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editNetworkForm">
                <input type="hidden" id="edit_net_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="edit_net_name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="edit_net_type">
                                <option value="lan">LAN</option>
                                <option value="wan">WAN</option>
                                <option value="dmz">DMZ</option>
                                <option value="guest">Guest</option>
                                <option value="management">Management</option>
                                <option value="voip">VoIP</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Network CIDR *</label>
                            <input type="text" class="form-control" id="edit_net_cidr" required placeholder="192.168.1.0/24">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gateway</label>
                            <input type="text" class="form-control" id="edit_net_gateway" placeholder="192.168.1.1">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">VLAN ID</label>
                            <input type="number" class="form-control" id="edit_net_vlan" min="1" max="4094">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">DNS Primario</label>
                            <input type="text" class="form-control" id="edit_net_dns">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Stato</label>
                            <select class="form-select" id="edit_net_active">
                                <option value="true">Attiva</option>
                                <option value="false">Inattiva</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <textarea class="form-control" id="edit_net_desc" rows="2"></textarea>
                    </div>
                    
                    <!-- Gateway ARP -->
                    <hr class="my-3">
                    <h6 class="text-muted"><i class="bi bi-diagram-3"></i> Gateway ARP (reti remote)</h6>
                    <div class="mb-3">
                        <label class="form-label">Metodo</label>
                        <select class="form-select" id="edit_net_gw_method" onchange="toggleEditGatewayFields()">
                            <option value="none">Nessuno (fallback automatico)</option>
                            <option value="mikrotik">MikroTik API</option>
                            <option value="snmp">SNMP generico</option>
                        </select>
                    </div>
                    <div id="edit_gw_mikrotik" style="display:none;">
                        <label class="form-label">Router MikroTik</label>
                        <select class="form-select" id="edit_net_gw_agent">
                            <option value="">-- Seleziona --</option>
                            {% for agent in agents %}
                            {% if agent.agent_type == 'mikrotik' %}
                            <option value="{{ agent.id }}">{{ agent.name }} ({{ agent.address }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div id="edit_gw_snmp" style="display:none;">
                        <div class="row">
                            <div class="col-5 mb-2">
                                <label class="form-label">IP Router</label>
                                <input type="text" class="form-control" id="edit_net_snmp_addr" placeholder="192.168.1.1">
                            </div>
                            <div class="col-4 mb-2">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" id="edit_net_snmp_comm" placeholder="public">
                            </div>
                            <div class="col-3 mb-2">
                                <label class="form-label">Versione</label>
                                <select class="form-select" id="edit_net_snmp_ver">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Assegna Credenziale Esistente -->
<div class="modal fade" id="assignCredentialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assegna Credenziale al Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignCredentialForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Seleziona Credenziale</label>
                        <select class="form-select" name="credential_id" required>
                            <option value="">-- Seleziona --</option>
                            {% for cred in global_credentials %}
                            <option value="{{ cred.id }}">{{ cred.name }} ({{ cred.credential_type }}) - {{ cred.username or 'N/A' }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Seleziona una credenziale globale da assegnare a questo cliente</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_default" id="assignIsDefault">
                        <label class="form-check-label" for="assignIsDefault">Imposta come default per questo cliente</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-link"></i> Assegna
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuova Credenziale -->
<div class="modal fade" id="newCredentialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuova Credenziale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newCredentialForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" name="name" required placeholder="Es: Admin SSH Linux">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo *</label>
                            <select class="form-select" name="credential_type" id="credentialType" onchange="toggleCredentialFields()">
                                <option value="ssh">SSH</option>
                                <option value="snmp">SNMP</option>
                                <option value="wmi">WMI (Windows)</option>
                                <option value="mikrotik">MikroTik API</option>
                                <option value="device">Device Generico</option>
                                <option value="api">API</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Default</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" name="is_default" id="isDefault">
                                <label class="form-check-label" for="isDefault">S√¨</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi comuni (username/password) -->
                    <div id="fieldsCommon">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="username" placeholder="admin">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" name="password">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi SSH -->
                    <div id="fieldsSSH" style="display: block;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SSH</label>
                                <input type="number" class="form-control" name="ssh_port" value="22" min="1" max="65535">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tipo Chiave</label>
                                <select class="form-select" name="ssh_key_type">
                                    <option value="">Password</option>
                                    <option value="rsa">RSA</option>
                                    <option value="ed25519">Ed25519</option>
                                    <option value="ecdsa">ECDSA</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Passphrase Chiave</label>
                                <input type="password" class="form-control" name="ssh_passphrase" placeholder="(opzionale)">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Chiave Privata SSH</label>
                            <textarea class="form-control" name="ssh_private_key" rows="3" placeholder="-----BEGIN RSA PRIVATE KEY-----&#10;...&#10;-----END RSA PRIVATE KEY-----"></textarea>
                        </div>
                    </div>
                    
                    <!-- Campi SNMP -->
                    <div id="fieldsSNMP" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Versione SNMP</label>
                                <select class="form-select" name="snmp_version" id="snmpVersion" onchange="toggleSNMPv3Fields()">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                    <option value="3">v3</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SNMP</label>
                                <input type="number" class="form-control" name="snmp_port" value="161" min="1" max="65535">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" name="snmp_community" placeholder="public">
                            </div>
                        </div>
                        <!-- Campi SNMPv3 -->
                        <div id="fieldsSNMPv3" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Security Level</label>
                                    <select class="form-select" name="snmp_security_level">
                                        <option value="noAuthNoPriv">noAuthNoPriv</option>
                                        <option value="authNoPriv">authNoPriv</option>
                                        <option value="authPriv">authPriv</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Auth Protocol</label>
                                    <select class="form-select" name="snmp_auth_protocol">
                                        <option value="">-</option>
                                        <option value="MD5">MD5</option>
                                        <option value="SHA">SHA</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Priv Protocol</label>
                                    <select class="form-select" name="snmp_priv_protocol">
                                        <option value="">-</option>
                                        <option value="DES">DES</option>
                                        <option value="AES">AES</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Auth Password</label>
                                    <input type="password" class="form-control" name="snmp_auth_password">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Priv Password</label>
                                    <input type="password" class="form-control" name="snmp_priv_password">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi WMI -->
                    <div id="fieldsWMI" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Dominio</label>
                                <input type="text" class="form-control" name="wmi_domain" placeholder="DOMAIN o . per locale">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Namespace</label>
                                <input type="text" class="form-control" name="wmi_namespace" placeholder="root/cimv2" value="root/cimv2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi MikroTik -->
                    <div id="fieldsMikroTik" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Porta API</label>
                                <input type="number" class="form-control" name="mikrotik_api_port" value="8728" min="1" max="65535">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SSL</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" name="mikrotik_api_ssl" id="mikrotikSsl">
                                    <label class="form-check-label" for="mikrotikSsl">Usa SSL (porta 8729)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi API -->
                    <div id="fieldsAPI" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" name="api_key">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" name="api_secret">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Endpoint</label>
                            <input type="url" class="form-control" name="api_endpoint" placeholder="https://api.example.com">
                        </div>
                    </div>
                    
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Filtro Device</label>
                        <input type="text" class="form-control" name="device_filter" placeholder="router-*, *-fw">
                        <small class="text-muted">Pattern per matching (usa * come wildcard)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Credenziale</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleCredentialFields() {
    const type = document.getElementById('credentialType').value;
    
    // Nascondi tutti i campi specifici
    document.getElementById('fieldsSSH').style.display = 'none';
    document.getElementById('fieldsSNMP').style.display = 'none';
    document.getElementById('fieldsWMI').style.display = 'none';
    document.getElementById('fieldsMikroTik').style.display = 'none';
    document.getElementById('fieldsAPI').style.display = 'none';
    document.getElementById('fieldsCommon').style.display = 'block';
    
    // Mostra i campi per il tipo selezionato
    if (type === 'ssh') {
        document.getElementById('fieldsSSH').style.display = 'block';
    } else if (type === 'snmp') {
        document.getElementById('fieldsSNMP').style.display = 'block';
        document.getElementById('fieldsCommon').style.display = 'none';
    } else if (type === 'wmi') {
        document.getElementById('fieldsWMI').style.display = 'block';
    } else if (type === 'mikrotik') {
        document.getElementById('fieldsMikroTik').style.display = 'block';
    } else if (type === 'api') {
        document.getElementById('fieldsAPI').style.display = 'block';
        document.getElementById('fieldsCommon').style.display = 'none';
    }
}

function toggleSNMPv3Fields() {
    const version = document.getElementById('snmpVersion').value;
    document.getElementById('fieldsSNMPv3').style.display = version === '3' ? 'block' : 'none';
}

// Network Edit/Delete
function editNetwork(net) {
    document.getElementById('edit_net_id').value = net.id;
    document.getElementById('edit_net_name').value = net.name || '';
    document.getElementById('edit_net_type').value = net.network_type || 'lan';
    document.getElementById('edit_net_cidr').value = net.ip_network || '';
    document.getElementById('edit_net_gateway').value = net.gateway || '';
    document.getElementById('edit_net_vlan').value = net.vlan_id || '';
    document.getElementById('edit_net_dns').value = net.dns_primary || '';
    document.getElementById('edit_net_active').value = net.active ? 'true' : 'false';
    document.getElementById('edit_net_desc').value = net.description || '';
    
    // Gateway ARP fields
    let method = 'none';
    if (net.gateway_agent_id) {
        method = 'mikrotik';
        document.getElementById('edit_net_gw_agent').value = net.gateway_agent_id;
    } else if (net.gateway_snmp_address) {
        method = 'snmp';
        document.getElementById('edit_net_snmp_addr').value = net.gateway_snmp_address;
        document.getElementById('edit_net_snmp_comm').value = net.gateway_snmp_community || 'public';
        document.getElementById('edit_net_snmp_ver').value = net.gateway_snmp_version || '2c';
    }
    document.getElementById('edit_net_gw_method').value = method;
    toggleEditGatewayFields();
    
    new bootstrap.Modal(document.getElementById('editNetworkModal')).show();
}

function toggleEditGatewayFields() {
    const method = document.getElementById('edit_net_gw_method').value;
    document.getElementById('edit_gw_mikrotik').style.display = method === 'mikrotik' ? 'block' : 'none';
    document.getElementById('edit_gw_snmp').style.display = method === 'snmp' ? 'block' : 'none';
}

document.getElementById('editNetworkForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const networkId = document.getElementById('edit_net_id').value;
    const gwMethod = document.getElementById('edit_net_gw_method').value;
    
    const data = {
        name: document.getElementById('edit_net_name').value,
        network_type: document.getElementById('edit_net_type').value,
        ip_network: document.getElementById('edit_net_cidr').value,
        gateway: document.getElementById('edit_net_gateway').value || null,
        vlan_id: document.getElementById('edit_net_vlan').value ? parseInt(document.getElementById('edit_net_vlan').value) : null,
        dns_primary: document.getElementById('edit_net_dns').value || null,
        active: document.getElementById('edit_net_active').value === 'true',
        description: document.getElementById('edit_net_desc').value || null,
        gateway_agent_id: gwMethod === 'mikrotik' ? (document.getElementById('edit_net_gw_agent').value || null) : null,
        gateway_snmp_address: gwMethod === 'snmp' ? (document.getElementById('edit_net_snmp_addr').value || null) : null,
        gateway_snmp_community: gwMethod === 'snmp' ? (document.getElementById('edit_net_snmp_comm').value || null) : null,
        gateway_snmp_version: gwMethod === 'snmp' ? (document.getElementById('edit_net_snmp_ver').value || null) : null
    };
    
    try {
        const response = await fetch(`/api/v1/customers/networks/${networkId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || 'Salvataggio fallito'));
        }
    } catch (err) {
        alert('Errore: ' + err.message);
    }
});

async function deleteNetwork(networkId, networkName) {
    if (!confirm(`Eliminare la rete "${networkName}"?`)) return;
    
    try {
        const response = await fetch(`/api/v1/customers/networks/${networkId}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            location.reload();
        } else {
            alert('Errore nella cancellazione');
        }
    } catch (err) {
        alert('Errore: ' + err.message);
    }
}

// Gateway ARP Configuration
function toggleGatewayFields() {
    const method = document.getElementById('gw_method').value;
    document.getElementById('gw_mikrotik_fields').style.display = method === 'mikrotik' ? 'block' : 'none';
    document.getElementById('gw_snmp_fields').style.display = method === 'snmp' ? 'block' : 'none';
}

function configureGateway(networkId, networkName, agentId, snmpAddr, snmpCommunity, snmpVersion) {
    document.getElementById('gw_network_id').value = networkId;
    document.getElementById('gw_network_name').textContent = networkName;
    
    // Determine method
    let method = 'none';
    if (agentId) {
        method = 'mikrotik';
        document.getElementById('gw_agent_id').value = agentId;
    } else if (snmpAddr) {
        method = 'snmp';
        document.getElementById('gw_snmp_address').value = snmpAddr;
        document.getElementById('gw_snmp_community').value = snmpCommunity || 'public';
        document.getElementById('gw_snmp_version').value = snmpVersion || '2c';
    }
    document.getElementById('gw_method').value = method;
    toggleGatewayFields();
    
    new bootstrap.Modal(document.getElementById('gatewayModal')).show();
}

document.getElementById('gatewayForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const networkId = document.getElementById('gw_network_id').value;
    const method = document.getElementById('gw_method').value;
    
    console.log('Gateway form submit:', {networkId, method});
    
    let data = {
        gateway_agent_id: null,
        gateway_snmp_address: null,
        gateway_snmp_community: null,
        gateway_snmp_version: null
    };
    
    if (method === 'mikrotik') {
        data.gateway_agent_id = document.getElementById('gw_agent_id').value || null;
    } else if (method === 'snmp') {
        data.gateway_snmp_address = document.getElementById('gw_snmp_address').value || null;
        data.gateway_snmp_community = document.getElementById('gw_snmp_community').value || 'public';
        data.gateway_snmp_version = document.getElementById('gw_snmp_version').value || '2c';
    }
    
    console.log('Sending data:', data);
    
    try {
        const response = await fetch(`/api/v1/customers/networks/${networkId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        console.log('Response status:', response.status);
        
        if (response.ok) {
            // Chiudi modal e reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('gatewayModal'));
            if (modal) modal.hide();
            window.location.reload();
        } else {
            const err = await response.json();
            console.error('Save error:', err);
            alert('Errore nel salvataggio: ' + (err.detail || response.status));
        }
    } catch (err) {
        console.error('Fetch error:', err);
        alert('Errore: ' + err.message);
    }
});

// Init
document.addEventListener('DOMContentLoaded', function() {
    toggleCredentialFields();
});
</script>

<!-- Modal Modifica Credenziale -->
<div class="modal fade" id="editCredentialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica Credenziale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCredentialForm">
                <input type="hidden" name="credential_id" id="editCredentialId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" name="name" id="editCredName" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo *</label>
                            <select class="form-select" name="credential_type" id="editCredType" onchange="toggleEditCredentialFields()">
                                <option value="ssh">SSH</option>
                                <option value="snmp">SNMP</option>
                                <option value="wmi">WMI (Windows)</option>
                                <option value="mikrotik">MikroTik API</option>
                                <option value="device">Device Generico</option>
                                <option value="api">API</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Default</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" name="is_default" id="editIsDefault">
                                <label class="form-check-label" for="editIsDefault">S√¨</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi comuni -->
                    <div id="editFieldsCommon">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="username" id="editUsername">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Password <small class="text-muted">(lascia vuoto per non modificare)</small></label>
                                <input type="password" class="form-control" name="password" id="editPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi SSH -->
                    <div id="editFieldsSSH" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SSH</label>
                                <input type="number" class="form-control" name="ssh_port" id="editSshPort" min="1" max="65535">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tipo Chiave</label>
                                <select class="form-select" name="ssh_key_type" id="editSshKeyType">
                                    <option value="">Password</option>
                                    <option value="rsa">RSA</option>
                                    <option value="ed25519">Ed25519</option>
                                    <option value="ecdsa">ECDSA</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Passphrase</label>
                                <input type="password" class="form-control" name="ssh_passphrase" id="editSshPassphrase">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Chiave Privata SSH <small class="text-muted">(lascia vuoto per non modificare)</small></label>
                            <textarea class="form-control" name="ssh_private_key" id="editSshPrivateKey" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <!-- Campi SNMP -->
                    <div id="editFieldsSNMP" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Versione SNMP</label>
                                <select class="form-select" name="snmp_version" id="editSnmpVersion" onchange="toggleEditSNMPv3Fields()">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                    <option value="3">v3</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SNMP</label>
                                <input type="number" class="form-control" name="snmp_port" id="editSnmpPort" min="1" max="65535">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" name="snmp_community" id="editSnmpCommunity">
                            </div>
                        </div>
                        <div id="editFieldsSNMPv3" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Security Level</label>
                                    <select class="form-select" name="snmp_security_level" id="editSnmpSecurityLevel">
                                        <option value="noAuthNoPriv">noAuthNoPriv</option>
                                        <option value="authNoPriv">authNoPriv</option>
                                        <option value="authPriv">authPriv</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Auth Protocol</label>
                                    <select class="form-select" name="snmp_auth_protocol" id="editSnmpAuthProtocol">
                                        <option value="">-</option>
                                        <option value="MD5">MD5</option>
                                        <option value="SHA">SHA</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Priv Protocol</label>
                                    <select class="form-select" name="snmp_priv_protocol" id="editSnmpPrivProtocol">
                                        <option value="">-</option>
                                        <option value="DES">DES</option>
                                        <option value="AES">AES</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Auth Password</label>
                                    <input type="password" class="form-control" name="snmp_auth_password" id="editSnmpAuthPassword">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Priv Password</label>
                                    <input type="password" class="form-control" name="snmp_priv_password" id="editSnmpPrivPassword">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi WMI -->
                    <div id="editFieldsWMI" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Dominio</label>
                                <input type="text" class="form-control" name="wmi_domain" id="editWmiDomain">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Namespace</label>
                                <input type="text" class="form-control" name="wmi_namespace" id="editWmiNamespace">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi MikroTik -->
                    <div id="editFieldsMikroTik" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Porta API</label>
                                <input type="number" class="form-control" name="mikrotik_api_port" id="editMikrotikApiPort" min="1" max="65535">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SSL</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" name="mikrotik_api_ssl" id="editMikrotikSsl">
                                    <label class="form-check-label" for="editMikrotikSsl">Usa SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi API -->
                    <div id="editFieldsAPI" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" name="api_key" id="editApiKey">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" name="api_secret" id="editApiSecret">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Endpoint</label>
                            <input type="url" class="form-control" name="api_endpoint" id="editApiEndpoint">
                        </div>
                    </div>
                    
                    <hr>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Filtro Device</label>
                            <input type="text" class="form-control" name="device_filter" id="editDeviceFilter">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Stato</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" name="active" id="editActive">
                                <label class="form-check-label" for="editActive">Attiva</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <textarea class="form-control" name="description" id="editDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleEditCredentialFields() {
    const type = document.getElementById('editCredType').value;
    
    document.getElementById('editFieldsSSH').style.display = 'none';
    document.getElementById('editFieldsSNMP').style.display = 'none';
    document.getElementById('editFieldsWMI').style.display = 'none';
    document.getElementById('editFieldsMikroTik').style.display = 'none';
    document.getElementById('editFieldsAPI').style.display = 'none';
    document.getElementById('editFieldsCommon').style.display = 'block';
    
    if (type === 'ssh') {
        document.getElementById('editFieldsSSH').style.display = 'block';
    } else if (type === 'snmp') {
        document.getElementById('editFieldsSNMP').style.display = 'block';
        document.getElementById('editFieldsCommon').style.display = 'none';
    } else if (type === 'wmi') {
        document.getElementById('editFieldsWMI').style.display = 'block';
    } else if (type === 'mikrotik') {
        document.getElementById('editFieldsMikroTik').style.display = 'block';
    } else if (type === 'api') {
        document.getElementById('editFieldsAPI').style.display = 'block';
        document.getElementById('editFieldsCommon').style.display = 'none';
    }
}

function toggleEditSNMPv3Fields() {
    const version = document.getElementById('editSnmpVersion').value;
    document.getElementById('editFieldsSNMPv3').style.display = version === '3' ? 'block' : 'none';
}

async function editCredential(credentialId) {
    try {
        // Carica dati credenziale
        const response = await fetch(`/api/v1/customers/credentials/${credentialId}`);
        if (!response.ok) throw new Error('Credenziale non trovata');
        
        const cred = await response.json();
        
        // Popola form
        document.getElementById('editCredentialId').value = cred.id;
        document.getElementById('editCredName').value = cred.name || '';
        document.getElementById('editCredType').value = cred.credential_type || 'device';
        document.getElementById('editIsDefault').checked = cred.is_default || false;
        document.getElementById('editUsername').value = cred.username || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editDeviceFilter').value = cred.device_filter || '';
        document.getElementById('editActive').checked = cred.active !== false;
        document.getElementById('editDescription').value = cred.description || '';
        
        // SSH
        document.getElementById('editSshPort').value = cred.ssh_port || 22;
        document.getElementById('editSshKeyType').value = cred.ssh_key_type || '';
        document.getElementById('editSshPassphrase').value = '';
        document.getElementById('editSshPrivateKey').value = '';
        
        // SNMP
        document.getElementById('editSnmpVersion').value = cred.snmp_version || '2c';
        document.getElementById('editSnmpPort').value = cred.snmp_port || 161;
        document.getElementById('editSnmpCommunity').value = cred.snmp_community || '';
        document.getElementById('editSnmpSecurityLevel').value = cred.snmp_security_level || 'noAuthNoPriv';
        document.getElementById('editSnmpAuthProtocol').value = cred.snmp_auth_protocol || '';
        document.getElementById('editSnmpPrivProtocol').value = cred.snmp_priv_protocol || '';
        
        // WMI
        document.getElementById('editWmiDomain').value = cred.wmi_domain || '';
        document.getElementById('editWmiNamespace').value = cred.wmi_namespace || 'root/cimv2';
        
        // MikroTik
        document.getElementById('editMikrotikApiPort').value = cred.mikrotik_api_port || 8728;
        document.getElementById('editMikrotikSsl').checked = cred.mikrotik_api_ssl || false;
        
        // API
        document.getElementById('editApiKey').value = '';
        document.getElementById('editApiSecret').value = '';
        document.getElementById('editApiEndpoint').value = cred.api_endpoint || '';
        
        // Mostra campi appropriati
        toggleEditCredentialFields();
        toggleEditSNMPv3Fields();
        
        // Mostra modal
        new bootstrap.Modal(document.getElementById('editCredentialModal')).show();
        
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function deleteCredential(credentialId, credentialName) {
    if (!confirm(`Eliminare la credenziale "${credentialName}"?`)) return;
    
    try {
        const response = await fetch(`/api/v1/customers/credentials/${credentialId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || 'Eliminazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Verifica stato credenziale
async function testCredential(credentialId, credentialName, credentialType) {
    alert(`Credenziale "${credentialName}" (${credentialType})\n\n‚úÖ Credenziale configurata correttamente.\n\nPer testare la connessione, usa la credenziale su un dispositivo specifico.`);
}

// Rimuovi credenziale dal cliente (unlink, non elimina)
async function unlinkCredential(credentialId, credentialName) {
    if (!confirm(`Rimuovere la credenziale "${credentialName}" da questo cliente?\n\nLa credenziale non verr√† eliminata, solo dissociata.`)) return;
    
    try {
        const response = await fetch(`/api/v1/customers/{{ customer.id }}/credential-links/${credentialId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || 'Rimozione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Rimuovi agent dal cliente (unlink, non elimina)
async function unlinkAgent(agentId, agentName) {
    if (!confirm(`Rimuovere la sonda "${agentName}" da questo cliente?\n\nLa sonda non verr√† eliminata, solo dissociata e torner√† in attesa di approvazione.`)) return;
    
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/unassign`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || 'Rimozione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Form Modifica Credenziale
document.getElementById('editCredentialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const credentialId = document.getElementById('editCredentialId').value;
    const formData = new FormData(e.target);
    const data = {};
    
    // Prendi solo i campi con valore
    for (const [key, value] of formData.entries()) {
        if (key === 'credential_id') continue;
        if (value !== '' && value !== null) {
            data[key] = value;
        }
    }
    
    // Gestisci checkbox
    data.is_default = document.getElementById('editIsDefault').checked;
    data.active = document.getElementById('editActive').checked;
    data.mikrotik_api_ssl = document.getElementById('editMikrotikSsl').checked;
    
    // Converti numeri
    if (data.ssh_port) data.ssh_port = parseInt(data.ssh_port);
    if (data.snmp_port) data.snmp_port = parseInt(data.snmp_port);
    if (data.mikrotik_api_port) data.mikrotik_api_port = parseInt(data.mikrotik_api_port);
    
    console.log('Update credential:', data);
    
    try {
        const response = await fetch(`/api/v1/customers/credentials/${credentialId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editCredentialModal')).hide();
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || JSON.stringify(err)));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
});
</script>

<!-- Modal Assegna Device -->
<div class="modal fade" id="assignDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assegna Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignDeviceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Dude Device ID *</label>
                        <input type="text" class="form-control" name="dude_device_id" required placeholder="*1 o ID del device">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome Device</label>
                            <input type="text" class="form-control" name="dude_device_name" placeholder="Router-Main">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ruolo</label>
                            <select class="form-select" name="role">
                                <option value="">-- Seleziona --</option>
                                <option value="router">Router</option>
                                <option value="switch">Switch</option>
                                <option value="firewall">Firewall</option>
                                <option value="access_point">Access Point</option>
                                <option value="server">Server</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location" placeholder="Sede Centrale">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">IP Management</label>
                            <input type="text" class="form-control" name="management_ip" placeholder="192.168.1.1">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contratto</label>
                            <select class="form-select" name="contract_type">
                                <option value="">-- Seleziona --</option>
                                <option value="standard">Standard</option>
                                <option value="premium">Premium</option>
                                <option value="24x7">24x7</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SLA</label>
                            <select class="form-select" name="sla_level">
                                <option value="">-- Seleziona --</option>
                                <option value="gold">Gold</option>
                                <option value="silver">Silver</option>
                                <option value="bronze">Bronze</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Assegna</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuova Sonda -->
<div class="modal fade" id="newAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-broadcast"></i> Nuova Sonda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newAgentForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome Sonda *</label>
                            <input type="text" class="form-control" name="name" required placeholder="Sonda Milano">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sede</label>
                            <input type="text" class="form-control" name="site_name" placeholder="Milano HQ">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Indirizzo IP/Hostname *</label>
                            <input type="text" class="form-control" name="address" required placeholder="192.168.1.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo Agent *</label>
                            <select class="form-select" name="agent_type" id="agentType" onchange="toggleAgentTypeFields()">
                                <option value="mikrotik">MikroTik (RouterOS nativo)</option>
                                <option value="docker">Docker Agent (WMI/SSH/SNMP)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campi MikroTik -->
                    <div id="mikrotikFields">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo Connessione</label>
                                <select class="form-select" name="connection_type" id="agentConnType" onchange="toggleConnectionFields()">
                                    <option value="api">Solo API RouterOS</option>
                                    <option value="ssh">Solo SSH</option>
                                    <option value="both">API + SSH</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campi API RouterOS -->
                        <div id="apiFields">
                            <hr><small class="text-muted">Connessione API RouterOS</small>
                            <div class="row mt-2">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Porta API</label>
                                    <input type="number" class="form-control" name="port" value="8728">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Opzioni API</label>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" name="use_ssl" id="agentUseSsl">
                                        <label class="form-check-label" for="agentUseSsl">Usa SSL/TLS (8729)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campi SSH -->
                        <div id="sshFields" style="display:none;">
                            <hr><small class="text-muted">Connessione SSH</small>
                            <div class="row mt-2">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Porta SSH</label>
                                    <input type="number" class="form-control" name="ssh_port" value="22">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Chiave Privata SSH (opzionale)</label>
                                    <textarea class="form-control" name="ssh_key" rows="2" placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea>
                                    <small class="text-muted">Lascia vuoto per usare password</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="username" id="agentUsername" placeholder="admin">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" name="password" id="agentPassword" placeholder="Lascia vuoto per mantenere password esistente">
                                <small class="text-muted">‚ö†Ô∏è <strong>Importante:</strong> Lascia vuoto per mantenere la password esistente. Inserisci nuova password solo per cambiarla.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi Docker Agent -->
                    <div id="dockerFields" style="display:none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Docker Agent</strong> - Container con capacit√† avanzate di probing (WMI, SSH, SNMP, Port Scan).
                            Pu√≤ essere deployato su MikroTik RouterOS 7 con container o su qualsiasi host Docker.
                        </div>
                        <hr><small class="text-muted">Configurazione Docker Agent</small>
                        <div class="row mt-2">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta API Agent</label>
                                <input type="number" class="form-control" name="agent_api_port" value="8080">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Token Autenticazione *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="agent_token" id="agentToken" placeholder="token-segreto">
                                    <button class="btn btn-outline-secondary" type="button" onclick="generateAgentToken()">
                                        <i class="bi bi-shuffle"></i> Genera
                                    </button>
                                </div>
                                <small class="text-muted">Deve corrispondere al token configurato nell'agent</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">URL Agent (opzionale)</label>
                                <input type="text" class="form-control" name="agent_url" placeholder="http://192.168.1.1:8080">
                                <small class="text-muted">Lascia vuoto per usare http://{indirizzo}:{porta}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DNS Server</label>
                                <input type="text" class="form-control" name="dns_server" placeholder="192.168.1.1">
                                <small class="text-muted">IP del DNS locale per reverse lookup</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo Scansione Default</label>
                            <select class="form-select" name="default_scan_type">
                                <option value="ping">Ping (veloce)</option>
                                <option value="arp">ARP (rete locale)</option>
                                <option value="snmp">SNMP (dettagliato)</option>
                                <option value="all">Completa</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Opzioni Discovery</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="auto_add_devices" id="agentAutoAdd">
                                <label class="form-check-label" for="agentAutoAdd">Aggiungi device automaticamente</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetAgentForm()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Sonda</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const customerId = '{{ customer.id }}';

// Cache per valori autocompletamento
const autocompleteCache = {
    device_types: null,
    categories: null,
    os_families: null,
    manufacturers: null
};

// Carica opzioni autocompletamento da API
async function loadAutocompleteOptions(fieldName, apiEndpoint) {
    // Usa cache se disponibile
    if (autocompleteCache[fieldName]) {
        return autocompleteCache[fieldName];
    }
    
    try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) {
            return [];
        }
        const data = await response.json();
        const values = data.values || [];
        autocompleteCache[fieldName] = values;
        return values;
    } catch (e) {
        console.error(`Error loading autocomplete options for ${fieldName}:`, e);
        return [];
    }
}

// Popola datalist con opzioni
async function populateDatalist(datalistId, apiEndpoint, fieldName) {
    const datalist = document.getElementById(datalistId);
    if (!datalist) return;
    
    // Se gi√† popolato, skip
    if (datalist.children.length > 0) return;
    
    const options = await loadAutocompleteOptions(fieldName, apiEndpoint);
    options.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        datalist.appendChild(option);
    });
}

// Popola tutti i datalist quando viene caricato l'inventario
async function populateAllDatalists() {
    const autocompleteFields = document.querySelectorAll('.autocomplete-field');
    const promises = [];
    
    autocompleteFields.forEach(field => {
        const deviceId = field.getAttribute('data-device-id');
        const fieldName = field.getAttribute('data-field');
        const apiEndpoint = field.getAttribute('data-api-endpoint');
        const listId = field.getAttribute('list');
        
        if (listId && apiEndpoint) {
            // Estrai nome campo dalla API endpoint
            const cacheKey = apiEndpoint.split('/').pop().replace('-', '_');
            promises.push(populateDatalist(listId, apiEndpoint, cacheKey));
        }
    });
    
    await Promise.all(promises);
}

// Aggiorna campo device da input
async function updateDeviceFieldFromInput(input) {
    const deviceId = input.getAttribute('data-device-id');
    const fieldName = input.getAttribute('data-field');
    const fieldValue = input.value.trim();
    
    if (!deviceId || !fieldName) return;
    
    // Se il valore non √® cambiato, non fare nulla
    const device = window.inventoryDevices?.find(d => d.id === deviceId);
    if (device && device[fieldName] === fieldValue) {
        return;
    }
    
    await updateDeviceField(deviceId, fieldName, fieldValue || null);
}

// Aggiorna un campo specifico di un device
async function updateDeviceField(deviceId, fieldName, fieldValue) {
    try {
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [fieldName]: fieldValue })
        });
        
        if (response.ok) {
            const result = await response.json();
            // Aggiorna il device nella lista locale
            if (window.inventoryDevices) {
                const device = window.inventoryDevices.find(d => d.id === deviceId);
                if (device) {
                    device[fieldName] = fieldValue;
                }
            }
            // Mostra notifica di successo (se disponibile)
            if (window.toastSuccess) {
                window.toastSuccess(`Campo ${fieldName} aggiornato`);
            }
            return result;
        } else {
            const error = await response.json();
            if (window.toastError) {
                window.toastError(`Errore aggiornamento: ${error.detail || 'Errore sconosciuto'}`);
            } else {
                alert(`Errore: ${error.detail || 'Errore sconosciuto'}`);
            }
            throw new Error(error.detail || 'Errore aggiornamento');
        }
    } catch (e) {
        console.error(`Error updating device field ${fieldName}:`, e);
        if (window.toastError) {
            window.toastError(`Errore: ${e.message}`);
        } else {
            alert(`Errore: ${e.message}`);
        }
        throw e;
    }
}

// Helper per parsare open_ports (pu√≤ essere stringa JSON o array)
function parseOpenPorts(openPorts) {
    if (!openPorts) return [];
    if (Array.isArray(openPorts)) return openPorts;
    if (typeof openPorts === 'string') {
        try {
            const parsed = JSON.parse(openPorts);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            return [];
        }
    }
    return [];
}

// Form Nuova Rete
document.getElementById('newNetworkForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    if (data.vlan_id) data.vlan_id = parseInt(data.vlan_id);
    
    const response = await fetch(`/api/v1/customers/${customerId}/networks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) location.reload();
    else alert('Errore: ' + (await response.json()).detail);
});

// Form Nuova Credenziale
// Form Assegna Credenziale Esistente
document.getElementById('assignCredentialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const credentialId = formData.get('credential_id');
    const isDefault = document.getElementById('assignIsDefault').checked;
    
    try {
        const response = await fetch(`/api/v1/customers/{{ customer.id }}/credential-links`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                credential_id: credentialId,
                is_default: isDefault
            })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || 'Assegnazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
});

document.getElementById('newCredentialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Gestisci checkbox
    data.is_default = e.target.is_default.checked;
    data.mikrotik_api_ssl = e.target.mikrotik_api_ssl?.checked || false;
    
    // Converti numeri
    if (data.ssh_port) data.ssh_port = parseInt(data.ssh_port);
    if (data.snmp_port) data.snmp_port = parseInt(data.snmp_port);
    if (data.mikrotik_api_port) data.mikrotik_api_port = parseInt(data.mikrotik_api_port);
    
    // Rimuovi campi vuoti
    Object.keys(data).forEach(k => { 
        if (data[k] === '' || data[k] === null || data[k] === undefined) delete data[k]; 
    });
    
    console.log('Credential data:', data);
    
    const response = await fetch(`/api/v1/customers/${customerId}/credentials`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('newCredentialModal')).hide();
        location.reload();
    } else {
        const err = await response.json();
        alert('Errore: ' + (err.detail || JSON.stringify(err)));
    }
});

// Form Assegna Device
document.getElementById('assignDeviceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Rimuovi campi vuoti
    Object.keys(data).forEach(k => { if (!data[k]) delete data[k]; });
    
    const response = await fetch(`/api/v1/customers/${customerId}/devices`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) location.reload();
    else alert('Errore: ' + (await response.json()).detail);
});

// Form Nuova Sonda / Modifica Sonda
document.getElementById('newAgentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Verifica se √® modifica o creazione
    const editAgentId = form.dataset.editAgentId;
    const isEdit = !!editAgentId;
    
    // Converti checkbox
    if (e.target.use_ssl) data.use_ssl = e.target.use_ssl.checked;
    if (e.target.auto_add_devices) data.auto_add_devices = e.target.auto_add_devices.checked;
    
    // Converti porte a numero
    if (data.port) data.port = parseInt(data.port);
    if (data.ssh_port) data.ssh_port = parseInt(data.ssh_port);
    if (data.agent_api_port) data.agent_api_port = parseInt(data.agent_api_port);
    
    // Per MikroTik: verifica che username e password siano presenti
    if (data.agent_type === 'mikrotik' || !data.agent_type) {
        if (!data.username || !data.username.trim()) {
            alert('‚ö†Ô∏è Username √® obbligatorio per agent MikroTik');
            return;
        }
        if (!data.password || !data.password.trim()) {
            alert('‚ö†Ô∏è Password √® obbligatoria per agent MikroTik');
            return;
        }
    }
    
    // Rimuovi campi vuoti (ma preserva password anche se vuota per modifica)
    Object.keys(data).forEach(k => { 
        if (data[k] === '' || data[k] === null) {
            // Se √® modifica e il campo √® password vuoto, preservalo per indicare di mantenere quella esistente
            if (isEdit && k === 'password' && !data[k]) {
                delete data[k]; // Rimuovi per preservare password esistente
            } else if (k !== 'password') {
                delete data[k];
            }
        }
    });
    
    console.log('Agent data:', data, 'isEdit:', isEdit);
    
    let response;
    if (isEdit) {
        // Modifica agent esistente
        response = await fetch(`/api/v1/customers/agents/${editAgentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    } else {
        // Crea nuovo agent
        response = await fetch(`/api/v1/customers/${customerId}/agents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    }
    
    if (response.ok) {
        // Reset form e chiudi modal
        form.reset();
        delete form.dataset.editAgentId;
        const modal = bootstrap.Modal.getInstance(document.getElementById('newAgentModal'));
        if (modal) modal.hide();
        // Reset titolo e bottone
        const modalTitle = document.querySelector('#newAgentModal .modal-title');
        const submitBtn = document.querySelector('#newAgentForm button[type="submit"]');
        if (modalTitle) modalTitle.textContent = 'Nuova Sonda';
        if (submitBtn) submitBtn.textContent = 'Crea Sonda';
        location.reload();
    } else {
        const error = await response.json();
        alert('Errore: ' + (error.detail || 'Errore sconosciuto'));
    }
});

// Toggle campi in base al tipo Agent (MikroTik vs Docker)
function toggleAgentTypeFields() {
    const agentType = document.getElementById('agentType').value;
    const mikrotikFields = document.getElementById('mikrotikFields');
    const dockerFields = document.getElementById('dockerFields');
    
    if (agentType === 'docker') {
        mikrotikFields.style.display = 'none';
        dockerFields.style.display = 'block';
    } else {
        mikrotikFields.style.display = 'block';
        dockerFields.style.display = 'none';
    }
}

// Genera token casuale per agent Docker
function generateAgentToken() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let token = '';
    for (let i = 0; i < 32; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('agentToken').value = token;
}

// Toggle campi API/SSH in base al tipo connessione
function toggleConnectionFields() {
    const connType = document.getElementById('agentConnType').value;
    const apiFields = document.getElementById('apiFields');
    const sshFields = document.getElementById('sshFields');
    
    apiFields.style.display = (connType === 'api' || connType === 'both') ? 'block' : 'none';
    sshFields.style.display = (connType === 'ssh' || connType === 'both') ? 'block' : 'none';
}

// Mostra capacit√† agent Docker
async function showAgentCapabilities(agentId) {
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/test`, { method: 'POST' });
        const result = await response.json();
        
        // Supporta sia WebSocket che HTTP legacy
        const info = result.results?.websocket || result.results?.docker;
        
        if (info) {
            let msg = `Docker Agent: ${result.status}\n`;
            msg += `Connessione: ${result.connection_type || 'N/A'}\n\n`;
            msg += `Agent ID: ${info.agent_id || 'N/A'}\n`;
            msg += `Versione: ${info.version || 'N/A'}\n`;
            msg += `IP: ${info.ip_address || 'N/A'}\n`;
            
            if (info.connected_at) {
                msg += `Connesso da: ${new Date(info.connected_at).toLocaleString()}\n`;
            }
            if (info.last_heartbeat) {
                msg += `Ultimo heartbeat: ${new Date(info.last_heartbeat).toLocaleString()}\n`;
            }
            if (info.capabilities) {
                msg += `\nCapacit√†:\n`;
                info.capabilities.forEach(cap => {
                    msg += `  ‚úì ${cap.toUpperCase()}\n`;
                });
            }
            alert(msg);
        } else if (result.success) {
            alert(`Agent connesso: ${result.message}`);
        } else {
            alert(`Agent non raggiungibile: ${result.message || 'Errore sconosciuto'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Auto-Detect dispositivi usando agent Docker
async function autoDetectWithAgent(agentId) {
    const address = prompt('Inserisci IP del dispositivo da identificare:', '');
    if (!address) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/v1/inventory/auto-detect?customer_id=${customerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                address: address,
                use_default_credentials: true,
                use_agent: true,
                agent_id: agentId
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.scan_result) {
            const sr = result.scan_result;
            let msg = `Dispositivo identificato!\n\n`;
            msg += `Indirizzo: ${sr.address || address}\n`;
            msg += `Tipo: ${sr.device_type || 'unknown'}\n`;
            msg += `Categoria: ${sr.category || 'N/A'}\n`;
            msg += `Hostname: ${sr.hostname || 'N/A'}\n`;
            msg += `OS: ${sr.os_name || sr.os_family || 'N/A'}\n`;
            msg += `Vendor: ${sr.vendor || sr.manufacturer || 'N/A'}\n`;
            msg += `Model: ${sr.model || 'N/A'}\n`;
            msg += `Identificato via: ${sr.identified_by || 'N/A'}\n`;
            
            const parsedPorts = parseOpenPorts(result.open_ports);
            if (parsedPorts.length > 0) {
                const openPorts = parsedPorts.filter(p => p.open).map(p => p.port);
                msg += `\nPorte aperte: ${openPorts.join(', ')}\n`;
            }
            
            if (confirm(msg + '\n\nVuoi importare questo dispositivo nell\'inventario?')) {
                // Importa nell'inventario
                const importResponse = await fetch(`/api/v1/inventory/devices?customer_id=${customerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: sr.address || address,
                        name: sr.hostname || sr.sysName || address,
                        hostname: sr.hostname,
                        device_type: sr.device_type || 'other',
                        category: sr.category,
                        os_family: sr.os_family,
                        os_version: sr.os_version,
                        open_ports: result.open_ports
                    })
                });
                
                if (importResponse.ok) {
                    alert('Dispositivo importato con successo!');
                    location.reload();
                } else {
                    alert('Errore durante l\'importazione');
                }
            }
        } else {
            alert('Dispositivo non identificato.\n\nErrore: ' + (result.error || 'Nessuna informazione'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Reset form agent quando si chiude il modal
function resetAgentForm() {
    const form = document.getElementById('newAgentForm');
    form.reset();
    delete form.dataset.editAgentId;
    const modalTitle = document.querySelector('#newAgentModal .modal-title');
    const submitBtn = document.querySelector('#newAgentForm button[type="submit"]');
    if (modalTitle) modalTitle.textContent = 'Nuova Sonda';
    if (submitBtn) submitBtn.textContent = 'Crea Sonda';
    // Reset placeholder password
    const passwordField = document.getElementById('agentPassword');
    if (passwordField) passwordField.placeholder = '';
}

// Modifica agent esistente
async function editAgent(agentId) {
    // Carica dati agent CON password per permettere modifica
    const response = await fetch(`/api/v1/customers/agents/${agentId}?include_password=true`);
    if (!response.ok) {
        alert('Errore caricamento agent');
        return;
    }
    const agent = await response.json();
    
    // Popola form e apri modal
    const form = document.getElementById('newAgentForm');
    form.name.value = agent.name || '';
    form.site_name.value = agent.site_name || '';
    form.address.value = agent.address || '';
    
    // Imposta tipo agent
    const agentType = document.getElementById('agentType');
    agentType.value = agent.agent_type || 'mikrotik';
    toggleAgentTypeFields();
    
    if (agent.agent_type === 'docker') {
        form.agent_api_port.value = agent.agent_api_port || 8080;
        form.dns_server.value = agent.dns_server || '';
        // Per Docker agent, mostra token se presente
        if (agent.agent_token) {
            form.agent_token.value = agent.agent_token;
        }
    } else {
        form.connection_type.value = agent.connection_type || 'api';
        form.port.value = agent.port || 8728;
        form.ssh_port.value = agent.ssh_port || 22;
        if (agent.use_ssl) form.use_ssl.checked = true;
        toggleConnectionFields();
    }
    
    // Popola username e password per permettere modifica
    form.username.value = agent.username || '';
    // Mostra password esistente (gi√† decriptata dal backend) per permettere modifica
    // Se vuota, lascia campo vuoto con placeholder
    if (agent.password && agent.password.trim()) {
        form.password.value = agent.password;
        form.password.placeholder = 'Password attuale (modifica per cambiarla)';
    } else {
        form.password.value = '';
        form.password.placeholder = 'Inserisci password (obbligatoria per MikroTik)';
    }
    
    // Modifica il submit per fare PUT invece di POST
    form.dataset.editAgentId = agentId;
    
    // Cambia titolo modal e testo bottone
    const modalTitle = document.querySelector('#newAgentModal .modal-title');
    const submitBtn = document.querySelector('#newAgentForm button[type="submit"]');
    if (modalTitle) modalTitle.textContent = 'Modifica Sonda';
    if (submitBtn) submitBtn.textContent = 'Salva Modifiche';
    
    // Apri modal
    const modal = new bootstrap.Modal(document.getElementById('newAgentModal'));
    modal.show();
}

// Test Sonda (API, SSH o Docker)
async function testAgent(agentId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/test`, { method: 'POST' });
        const result = await response.json();
        
        let msg = `Test ${result.connection_type.toUpperCase()}: ${result.status}\n\n`;
        
        // Docker Agent via WebSocket
        if (result.results && result.results.websocket) {
            const ws = result.results.websocket;
            msg += `Docker Agent: ‚úÖ Online (WebSocket)\n`;
            msg += `  Agent ID: ${ws.agent_id || 'N/A'}\n`;
            msg += `  Versione: ${ws.version || 'N/A'}\n`;
            msg += `  IP: ${ws.ip_address || 'N/A'}\n`;
        }
        // Docker Agent via HTTP (legacy)
        else if (result.results && result.results.docker) {
            const docker = result.results.docker;
            if (docker.status === 'healthy') {
                msg += `Docker Agent: ‚úÖ Online (HTTP)\n`;
                msg += `  Agent ID: ${docker.agent_id || 'N/A'}\n`;
                msg += `  Nome: ${docker.agent_name || 'N/A'}\n`;
                msg += `  Versione: ${docker.version || 'N/A'}\n`;
                if (docker.capabilities) {
                    msg += `  Capacit√†: ${docker.capabilities.join(', ')}\n`;
                }
            } else {
                msg += `Docker Agent: ‚ùå ${docker.error || 'Non raggiungibile'}\n`;
            }
        }
        
        // MikroTik API
        if (result.results && result.results.api) {
            msg += `API: ${result.results.api.success ? '‚úÖ' : '‚ùå'} ${result.results.api.message}\n`;
            if (result.results.api.version) msg += `  Versione: ${result.results.api.version}\n`;
        }
        
        // MikroTik SSH
        if (result.results && result.results.ssh) {
            msg += `SSH: ${result.results.ssh.success ? '‚úÖ' : '‚ùå'} ${result.results.ssh.message}\n`;
        }
        
        alert(msg);
        location.reload();
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Carica scansioni del cliente
async function loadScans() {
    const tbody = document.getElementById('scansTableBody');
    if (!tbody) {
        console.error('scansTableBody not found');
        return;
    }
    
    // Ottieni customer_id dall'URL o dal template
    const customerId = '{{ customer.id }}' || window.location.pathname.match(/\/customers\/([^\/]+)/)?.[1];
    if (!customerId) {
        console.error('Customer ID not found');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Errore: Customer ID non trovato</td></tr>';
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/customers/${customerId}/scans?limit=20`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        
        if (data.scans && data.scans.length > 0) {
            tbody.innerHTML = data.scans.map(scan => {
                const statusBadge = scan.status === 'completed' 
                    ? '<span class="badge bg-success">Completata</span>'
                    : scan.status === 'running'
                    ? '<span class="badge bg-primary"><i class="bi bi-hourglass-split"></i> In Corso</span>'
                    : scan.status === 'failed'
                    ? '<span class="badge bg-danger">Fallita</span>'
                    : '<span class="badge bg-secondary">' + scan.status + '</span>';
                
                const date = scan.created_at ? new Date(scan.created_at).toLocaleString('it-IT') : '-';
                
                return `
                    <tr>
                        <td><code>${scan.network_cidr || '-'}</code></td>
                        <td><span class="badge bg-info">${scan.scan_type || '-'}</span></td>
                        <td>${statusBadge}</td>
                        <td><strong>${scan.devices_found || 0}</strong></td>
                        <td>${date}</td>
                        <td>
                            ${scan.status === 'completed' 
                                ? `<a href="/customers/${customerId}/scans/${scan.id}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Risultati
                                   </a>`
                                : scan.status === 'running'
                                ? '<span class="text-muted">In attesa...</span>'
                                : ''
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-3">
                        Nessuna scansione trovata
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger py-3">
                    Errore caricamento scansioni: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Funzione per pulire scansioni vecchie
async function cleanupOldScans() {
    const customerId = '{{ customer.id }}' || window.location.pathname.match(/\/customers\/([^\/]+)/)?.[1];
    if (!customerId) {
        alert('Errore: Customer ID non trovato');
        return;
    }
    
    // Chiedi quanti giorni mantenere
    const daysInput = prompt('Elimina scansioni pi√π vecchie di quanti giorni?\n(Inserisci un numero tra 1 e 365, default: 30)', '30');
    if (!daysInput) {
        return; // Utente ha annullato
    }
    
    const days = parseInt(daysInput);
    if (isNaN(days) || days < 1 || days > 365) {
        alert('Inserisci un numero valido tra 1 e 365');
        return;
    }
    
    // Conferma
    const confirmMsg = `Sei sicuro di voler eliminare tutte le scansioni pi√π vecchie di ${days} giorni?\n\nQuesta operazione eliminer√† anche tutti i dispositivi scoperti associati a quelle scansioni.`;
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        // Prima mostra preview
        const previewResponse = await fetch(`/api/v1/customers/${customerId}/scans?days=${days}&dry_run=true`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!previewResponse.ok) {
            throw new Error(`HTTP ${previewResponse.status}: ${previewResponse.statusText}`);
        }
        
        const previewData = await previewResponse.json();
        
        if (previewData.status === 'no_scans') {
            alert(previewData.message);
            return;
        }
        
        // Mostra preview e chiedi conferma finale
        const finalConfirm = confirm(
            `Trovate ${previewData.scan_count} scansioni pi√π vecchie di ${days} giorni.\n\n` +
            `Vuoi procedere con l'eliminazione?\n\n` +
            `Questa operazione non pu√≤ essere annullata.`
        );
        
        if (!finalConfirm) {
            return;
        }
        
        // Esegui eliminazione
        const deleteResponse = await fetch(`/api/v1/customers/${customerId}/scans?days=${days}&dry_run=false`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!deleteResponse.ok) {
            throw new Error(`HTTP ${deleteResponse.status}: ${deleteResponse.statusText}`);
        }
        
        const deleteData = await deleteResponse.json();
        
        alert(`‚úì ${deleteData.message}\n\nEliminate ${deleteData.deleted_count} scansioni.`);
        
        // Ricarica la lista scansioni
        await loadScans();
        
    } catch (error) {
        console.error('Error cleaning up scans:', error);
        alert(`Errore durante la pulizia: ${error.message}`);
    }
}

// Auto-refresh scansioni ogni 10 secondi se ci sono scansioni in corso
let scansRefreshInterval = null;
function startScansAutoRefresh() {
    if (scansRefreshInterval) return;
    
    scansRefreshInterval = setInterval(async () => {
        const tbody = document.getElementById('scansTableBody');
        if (!tbody) return;
        
        // Controlla se ci sono scansioni in corso
        const rows = tbody.querySelectorAll('tr');
        let hasRunning = false;
        for (const row of rows) {
            if (row.innerHTML.includes('In Corso')) {
                hasRunning = true;
                break;
            }
        }
        
        if (hasRunning) {
            await loadScans();
        } else {
            // Ferma auto-refresh se non ci sono scansioni in corso
            if (scansRefreshInterval) {
                clearInterval(scansRefreshInterval);
                scansRefreshInterval = null;
            }
        }
    }, 10000); // Refresh ogni 10 secondi
}

// Carica scansioni all'apertura del tab
(function() {
    // Funzione per inizializzare scansioni
    function initScans() {
        const tbody = document.getElementById('scansTableBody');
        if (!tbody) {
            console.log('scansTableBody not found, retrying...');
            // Se il tab non √® ancora caricato, riprova dopo un breve delay
            setTimeout(initScans, 500);
            return;
        }
        
        console.log('Initializing scans...');
        loadScans();
        startScansAutoRefresh();
    }
    
    // Listener globale per tutti i tab Bootstrap
    document.addEventListener('shown.bs.tab', function(event) {
        // Controlla se il tab attivato √® quello scansioni
        const target = event.target;
        if (target && (target.getAttribute('href') === '#scans' || target.id === 'scans-tab')) {
            console.log('Scans tab shown, initializing scans...');
            setTimeout(initScans, 100);
        }
        // Controlla se il tab attivato √® quello inventario
        if (target && (target.getAttribute('href') === '#inventory' || target.id === 'inventory-tab')) {
            console.log('Inventory tab shown, loading inventory...');
            setTimeout(loadInventory, 100);
        }
    });
    
    // Carica scansioni anche se il tab √® gi√† attivo al caricamento della pagina
    function checkAndInit() {
        const scansPane = document.getElementById('scans');
        if (scansPane && scansPane.classList.contains('active') && scansPane.classList.contains('show')) {
            console.log('Scans tab already active, initializing scans...');
            initScans();
        }
        const inventoryPane = document.getElementById('inventory');
        if (inventoryPane && inventoryPane.classList.contains('active') && inventoryPane.classList.contains('show')) {
            console.log('Inventory tab already active, loading inventory...');
            loadInventory();
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkAndInit, 200);
        });
    } else {
        // DOM gi√† caricato
        setTimeout(checkAndInit, 200);
    }
    
    // Fallback: anche quando viene chiamato loadInventory
    const originalLoadInventory = window.loadInventory;
    if (originalLoadInventory) {
        window.loadInventory = function() {
            originalLoadInventory.apply(this, arguments);
            setTimeout(initScans, 300);
        };
    }
})();

// Avvia Scansione
async function startScan(agentId) {
    const scanType = prompt('Tipo scansione (ping/arp/snmp/all):', 'ping');
    if (!scanType) return;
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/scan?scan_type=${scanType}`, { 
            method: 'POST' 
        });
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Scansione avviata!\nRete: ${result.network}\nID: ${result.discovery_id}`);
        } else {
            alert(`‚ùå Errore: ${result.error || result.detail}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Elimina Sonda
async function deleteAgent(agentId) {
    if (!confirm('Vuoi eliminare questa sonda?')) return;
    
    const response = await fetch(`/api/v1/customers/agents/${agentId}`, { method: 'DELETE' });
    if (response.ok) location.reload();
    else alert('Errore eliminazione');
}

// Scansiona tutte le reti del cliente
async function scanCustomerNetworks(agentId) {
    const scanType = prompt('Tipo scansione (arp/ping/all):', 'arp');
    if (!scanType) return;
    
    
    try {
        // Mostra loading
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        btn.disabled = true;
        
        const response = await fetch(
            `/api/v1/customers/agents/${agentId}/scan-customer-networks?scan_type=${scanType}`, 
            { method: 'POST' }
        );
        const result = await response.json();
        
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        if (result.networks_scanned > 0 && result.results[0]?.success) {
            const r = result.results[0];
            let msg = `‚úÖ Scansione completata!\n\n`;
            msg += `Rete: ${r.network_name} (${r.network_cidr})\n`;
            msg += `Dispositivi trovati: ${r.devices_found}\n\n`;
            
            // Mostra primi 10 dispositivi (devices √® il campo corretto)
            const deviceList = r.devices || r.results || [];
            if (deviceList.length > 0) {
                msg += `Primi dispositivi:\n`;
                deviceList.slice(0, 10).forEach(d => {
                    const name = d.hostname || d.identity || d.address || 'N/A';
                    const mac = d.mac_address || '';
                    msg += `‚Ä¢ ${name} - ${d.address || ''} ${mac ? '('+mac+')' : ''}\n`;
                });
                if (deviceList.length > 10) {
                    msg += `\n... e altri ${deviceList.length - 10} dispositivi`;
                }
            }
            
            alert(msg);
            
            // TODO: Aprire pagina dettagli risultati
        } else {
            alert(`‚ùå Errore: ${result.results?.[0]?.message || result.detail || 'Scansione fallita'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Esegui comando SSH
async function openSshTerminal(agentId) {
    const command = prompt('Comando da eseguire via SSH:', '/system identity print');
    if (!command) return;
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/ssh-command?command=${encodeURIComponent(command)}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        let msg = `Comando: ${result.command}\n`;
        msg += `Exit code: ${result.exit_code || 'N/A'}\n\n`;
        
        if (result.output) {
            msg += `Output:\n${result.output}\n`;
        }
        if (result.error) {
            msg += `Errore:\n${result.error}\n`;
        }
        
        alert(msg);
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// DISCOVERY & DEVICE IDENTIFICATION
// ==========================================

let discoveredDevices = [];

async function runCustomerDiscovery() {
    const networkSelect = document.getElementById('discoveryNetwork');
    const agentSelect = document.getElementById('discoveryAgent');
    
    const networkId = networkSelect ? networkSelect.value : '';
    const selectedNetworkOption = networkSelect ? networkSelect.options[networkSelect.selectedIndex] : null;
    const networkCidr = selectedNetworkOption ? selectedNetworkOption.getAttribute('data-cidr') || '' : '';
    const agentId = agentSelect ? agentSelect.value : '';
    
    // Ottieni il tipo di agent dall'attributo data
    const selectedOption = agentSelect ? agentSelect.options[agentSelect.selectedIndex] : null;
    const agentType = selectedOption ? selectedOption.getAttribute('data-agent-type') || 'mikrotik' : 'mikrotik';
    
    console.log('Discovery - NetworkId:', networkId, 'NetworkCidr:', networkCidr, 'Agent:', agentId, 'Type:', agentType);
    
    if (!networkCidr) {
        alert('Seleziona una rete da scansionare');
        return;
    }
    if (!agentId) {
        alert('Seleziona una sonda per la scansione');
        return;
    }
    
    const loading = document.getElementById('discoveryLoading');
    const loadingText = document.getElementById('discoveryLoadingText');
    const section = document.getElementById('discoverySection');
    
    loading.style.display = 'block';
    loadingText.textContent = 'Scansione in corso...';
    section.style.display = 'none';
    
    try {
        let scanUrl;
        if (agentType === 'docker') {
            // Scansiona via Docker Agent - passa network_ids se selezionato
            scanUrl = `/api/v1/customers/agents/${agentId}/scan-customer-networks?scan_type=ping`;
            if (networkId) {
                scanUrl += `&network_ids=${encodeURIComponent(networkId)}`;
            }
        } else {
            // Scansiona via sonda MikroTik
            scanUrl = `/api/v1/mikrotik/agents/${agentId}/ip-scan?network=${encodeURIComponent(networkCidr)}`;
        }
        
        const scanResponse = await fetch(scanUrl, { method: 'POST' });
        const scanData = await scanResponse.json();
        
        // Se la scansione √® in background, mostra messaggio e ricarica scansioni
        if (scanData.status === 'running' && scanData.scan_id) {
            loadingText.textContent = `Scansione avviata in background (ID: ${scanData.scan_id}). Puoi chiudere questa pagina.`;
            loading.style.display = 'block';
            // Ricarica scansioni per mostrare la nuova scansione
            setTimeout(() => {
                loadScans();
                startScansAutoRefresh();
            }, 1000);
            // Mostra messaggio informativo
            setTimeout(() => {
                alert(`‚úÖ Scansione avviata in background!\n\nID: ${scanData.scan_id}\n\nPuoi chiudere questa pagina, la scansione continuer√† in background.\n\nPuoi controllare lo stato nella sezione "Scansioni di Rete" sopra.`);
            }, 500);
            return;
        }
        
        // Gestisci formati diversi di risposta (MikroTik vs Docker)
        let scanResults = [];
        
        if (agentType === 'docker') {
            // Formato Docker: { networks_scanned: N, results: [{ network_id, success, devices_found, devices: [...] }] }
            if (scanData.results && scanData.results.length > 0) {
                const firstResult = scanData.results[0];
                if (!firstResult.success) {
                    throw new Error(firstResult.error || 'Scansione fallita');
                }
                // I dispositivi sono gi√† salvati nel DB, li recuperiamo dalla view_url
                // Per ora usiamo i risultati del ping scan
                scanResults = firstResult.devices || [];
            } else if (scanData.error) {
                throw new Error(scanData.error);
            }
        } else {
            // Formato MikroTik: { success: bool, results: [...] }
            if (!scanData.success) {
                throw new Error(scanData.error || 'Scansione fallita');
            }
            scanResults = scanData.results || [];
        }
        
        // Usa tutti i device trovati (MAC opzionale)
        if (scanResults.length === 0) {
            alert('Nessun dispositivo trovato nella rete');
            loading.style.display = 'none';
            return;
        }
        
        // Conta device con e senza MAC
        const devicesWithMac = scanResults.filter(d => d.mac_address && d.mac_address.trim() !== '');
        console.log(`Trovati ${scanResults.length} dispositivi (${devicesWithMac.length} con MAC)`);
        
        // Enrich con vendor info (solo per quelli con MAC)
        loadingText.textContent = `Trovati ${scanResults.length} dispositivi, identificazione...`;
        let enrichedDevices = scanResults;
        
        if (devicesWithMac.length > 0) {
            try {
                const enrichResponse = await fetch('/api/v1/inventory/enrich-devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ devices: devicesWithMac })
                });
                const enrichData = await enrichResponse.json();
                
                if (enrichData.success) {
                    // Merge enriched devices con quelli senza MAC
                    const enrichedMap = new Map(enrichData.devices.map(d => [d.address, d]));
                    enrichedDevices = scanResults.map(d => enrichedMap.get(d.address) || d);
                }
            } catch (e) {
                console.warn('Enrich failed:', e);
            }
        }

        discoveredDevices = enrichedDevices;

        // Scansiona porte, reverse DNS e suggerisci credenziali per ogni device
        loadingText.textContent = 'Scansione porte TCP/UDP e reverse DNS...';
        let scannedCount = 0;
        const totalDevices = discoveredDevices.length;
        
        const scanPromises = discoveredDevices.map(async (dev) => {
            try {
                // 1. Scansiona porte TCP/UDP
                try {
                    const portsResponse = await fetch(`/api/v1/inventory/scan-ports/${dev.address}`);
                    const portsData = await portsResponse.json();
                    if (portsData.success && portsData.open_ports) {
                        dev.open_ports = portsData.open_ports;
                        console.log(`Port scan ${dev.address}: ${portsData.active_count} porte aperte`);
                    }
                } catch (e) {
                    console.warn(`Port scan fallito per ${dev.address}:`, e);
                    dev.open_ports = [];
                }
                
                // 2. Suggerimento tipo credenziali (basato sulle porte appena scansionate)
                const response = await fetch(`/api/v1/inventory/suggest-credential-type/${dev.address}`);
                const data = await response.json();
                if (data.success && data.suggested_type !== 'unknown') {
                    dev.suggested_credential_type = data.suggested_type;
                }

                // 3. Reverse DNS se non ha hostname
                if (!dev.hostname && !dev.identity) {
                    try {
                        const dnsResponse = await fetch(`/api/v1/inventory/reverse-dns/${dev.address}`);
                        const dnsData = await dnsResponse.json();
                        if (dnsData.success && dnsData.hostname) {
                            dev.hostname = dnsData.hostname;
                            console.log(`Reverse DNS ${dev.address}: ${dnsData.hostname}`);
                        }
                    } catch (e) {
                        console.warn(`Reverse DNS fallito per ${dev.address}:`, e);
                    }
                }
                
                scannedCount++;
                loadingText.textContent = `Scansione porte e DNS: ${scannedCount}/${totalDevices}...`;
            } catch (e) {
                console.warn(`Errore scansione per ${dev.address}:`, e);
            }
        });
        await Promise.all(scanPromises);

        // Carica le credenziali disponibili
        const credResponse = await fetch(`/api/v1/customers/${customerId}/credentials`);
        const credData = await credResponse.json();
        const availableCredentials = credData.credentials || [];

        // Identifica automaticamente i dispositivi usando le credenziali suggerite
        loadingText.textContent = 'Identificazione automatica dispositivi...';
        const identificationPromises = discoveredDevices.map(async (dev) => {
            if (!dev.suggested_credential_type) return;

            // Trova credenziali del tipo suggerito
            const matchingCredentials = availableCredentials.filter(c =>
                c.type === dev.suggested_credential_type ||
                (dev.suggested_credential_type === 'wmi' && c.type === 'windows') ||
                (dev.suggested_credential_type === 'ssh' && c.type === 'linux') ||
                (dev.suggested_credential_type === 'mikrotik' && c.type === 'routeros')
            );

            if (matchingCredentials.length === 0) {
                console.warn(`Nessuna credenziale ${dev.suggested_credential_type} disponibile per ${dev.address}`);
                return;
            }

            // Prova a identificare il dispositivo
            try {
                const probeResponse = await fetch(`/api/v1/inventory/probe-device?customer_id=${customerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: dev.address,
                        mac_address: dev.mac_address,
                        credential_ids: matchingCredentials.map(c => c.id)
                    })
                });
                const probeData = await probeResponse.json();

                if (probeData.success && probeData.device_type) {
                    // Aggiorna il dispositivo con i dati identificati
                    Object.assign(dev, probeData);
                    console.log(`‚úÖ Identificato ${dev.address} come ${probeData.device_type}`);
                }
            } catch (e) {
                console.warn(`Errore identificazione ${dev.address}:`, e);
            }
        });
        await Promise.all(identificationPromises);

        // Render risultati
        renderDiscoveryResults();
        document.getElementById('discoveryDeviceCount').textContent = discoveredDevices.length;
        section.style.display = 'block';
        
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        loading.style.display = 'none';
    }
}

function renderDiscoveryResults() {
    const tbody = document.getElementById('discoveryResultsBody');
    tbody.innerHTML = '';
    
    const typeOptions = `
        <option value="other">Generico</option>
        <option value="mikrotik">MikroTik</option>
        <option value="network">Rete</option>
        <option value="windows">Windows</option>
        <option value="linux">Linux</option>
        <option value="printer">Stampante</option>
        <option value="camera">Telecamera</option>
        <option value="voip">VoIP</option>
    `;
    
    const vendorColors = {
        'MikroTik': 'danger', 'Cisco': 'primary', 'HP': 'info', 'Ubiquiti': 'success',
        'Hikvision': 'warning', 'Dahua': 'warning', 'Apple': 'secondary',
        'Dell': 'dark', 'Brother': 'info', 'Canon': 'info', 'default': 'secondary'
    };
    
    let identifiedCount = 0;
    
    discoveredDevices.forEach((dev, idx) => {
        // Vendor badge
        const vendor = dev.vendor || '';
        const vendorBadge = vendor 
            ? `<span class="badge bg-${vendorColors[vendor] || 'secondary'}">${vendor}</span>`
            : '<span class="text-muted">-</span>';
        
        // Mappa tipo credenziali -> tipo device
        const credentialToDeviceType = {
            'wmi': 'windows',
            'ssh': 'linux',
            'snmp': 'network',
            'mikrotik': 'mikrotik'
        };

        // Tipo suggerito: prima usa il tipo identificato, poi mappa dal tipo credenziali, infine 'other'
        let suggestedType = dev.identified_type || dev.suggested_type || 'other';
        if (!dev.identified_type && dev.suggested_credential_type && credentialToDeviceType[dev.suggested_credential_type]) {
            suggestedType = credentialToDeviceType[dev.suggested_credential_type];
            dev.suggested_type = suggestedType; // Salva per uso futuro
        }

        // Credenziali suggerite
        let credBadge = '<span class="text-muted small">-</span>';
        if (dev.suggested_credential_type) {
            const credTypes = {
                'wmi': { label: 'WMI', color: 'primary', icon: 'windows' },
                'ssh': { label: 'SSH', color: 'success', icon: 'terminal' },
                'snmp': { label: 'SNMP', color: 'info', icon: 'router' },
                'mikrotik': { label: 'MikroTik', color: 'danger', icon: 'gear' }
            };
            const credType = credTypes[dev.suggested_credential_type] || { label: dev.suggested_credential_type, color: 'secondary', icon: 'key' };
            credBadge = `<span class="badge bg-${credType.color}" title="Tipo suggerito in base alle porte aperte">
                <i class="bi bi-${credType.icon}"></i> ${credType.label}
            </span>`;
        }

        // Stato identificazione
        let statusBadge = '<span class="text-muted">-</span>';
        if (dev.identified_by) {
            identifiedCount++;
            const method = dev.identified_by.replace('probe_', '').replace('mac_vendor', 'MAC');
            statusBadge = `<span class="badge bg-success">${method}</span>`;
            if (dev.os_family) {
                statusBadge += ` <small>${dev.os_family}</small>`;
            }
        } else if (dev.vendor) {
            statusBadge = '<span class="badge bg-info">MAC</span>';
        }

        // Servizi aperti (porte)
        let servicesDisplay = '<span class="text-muted small">-</span>';
        const devOpenPorts = parseOpenPorts(dev.open_ports);
        if (devOpenPorts.length > 0) {
            const openServices = devOpenPorts.filter(p => p.open);
            if (openServices.length > 0) {
                const serviceList = openServices.slice(0, 5).map(s =>
                    `<span class="badge bg-info" title="Port ${s.port}/${s.protocol || 'tcp'}">${s.service || s.port}</span>`
                ).join(' ');
                const moreCount = openServices.length > 5 ? ` <small>(+${openServices.length - 5})</small>` : '';
                servicesDisplay = serviceList + moreCount;
            }
        }
        
        tbody.innerHTML += `
            <tr data-index="${idx}">
                <td><input type="checkbox" class="disc-cb" data-index="${idx}" checked></td>
                <td><code>${dev.address || '-'}</code></td>
                <td><code class="small">${dev.mac_address || '-'}</code></td>
                <td>${vendorBadge}</td>
                <td>
                    <select class="form-select form-select-sm disc-type" data-index="${idx}" style="width: 90px;">
                        ${typeOptions}
                    </select>
                </td>
                <td>${credBadge}</td>
                <td>${dev.hostname || dev.identity || '-'}</td>
                <td style="min-width: 200px;">${servicesDisplay}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
    
    // Imposta tipo per ogni device
    discoveredDevices.forEach((dev, idx) => {
        const select = document.querySelector(`.disc-type[data-index="${idx}"]`);
        if (select) {
            select.value = dev.identified_type || dev.suggested_type || 'other';
        }
    });
    
    // Badge identificati
    const badge = document.getElementById('discoveryIdentifiedBadge');
    if (identifiedCount > 0) {
        badge.textContent = `${identifiedCount} identificati`;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

function toggleAllDiscovered() {
    const checked = document.getElementById('selectAllDiscoveredCb').checked;
    document.querySelectorAll('.disc-cb').forEach(cb => cb.checked = checked);
}

function selectAllDiscovered() {
    document.getElementById('selectAllDiscoveredCb').checked = true;
    toggleAllDiscovered();
}

async function identifyDiscoveredDevices() {
    const checkboxes = document.querySelectorAll('.disc-cb:checked');
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un dispositivo');
        return;
    }
    
    // Usa automaticamente tutte le credenziali del cliente e globali
    // (quelle di tipo ssh, snmp, mikrotik)
    const credentialIds = [];
    
    // Aggiungi credenziali globali
    {% if global_credentials %}
    {% for cred in global_credentials %}
    {% if cred.credential_type in ['ssh', 'snmp', 'mikrotik'] %}
    credentialIds.push('{{ cred.id }}');
    {% endif %}
    {% endfor %}
    {% endif %}
    
    // Aggiungi credenziali del cliente
    {% if credentials %}
    {% for cred in credentials %}
    {% if cred.credential_type in ['ssh', 'snmp', 'mikrotik'] %}
    credentialIds.push('{{ cred.id }}');
    {% endif %}
    {% endfor %}
    {% endif %}
    
    if (credentialIds.length === 0) {
        alert('Nessuna credenziale disponibile per l\'identificazione. Configura almeno una credenziale SSH, SNMP o MikroTik.');
        return;
    }
    
    const devices = [];
    checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        const dev = discoveredDevices[idx];
        if (dev) {
            devices.push({ address: dev.address, mac_address: dev.mac_address });
        }
    });
    
    const loading = document.getElementById('discoveryLoading');
    const loadingText = document.getElementById('discoveryLoadingText');
    loading.style.display = 'block';
    loadingText.textContent = `Identificazione ${devices.length} dispositivi con ${credentialIds.length} credenziali...`;
    
    try {
        const response = await fetch(`/api/v1/inventory/probe-devices?customer_id=${customerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ devices, credential_ids: credentialIds })
        });
        const result = await response.json();
        
        if (result.success) {
            // Aggiorna discoveredDevices
            result.results.forEach(probeResult => {
                const idx = discoveredDevices.findIndex(d => d.address === probeResult.address);
                if (idx >= 0) {
                    discoveredDevices[idx] = {
                        ...discoveredDevices[idx],
                        ...probeResult,
                        identified_type: probeResult.device_type,
                    };
                }
            });
            
            renderDiscoveryResults();
            alert(`‚úÖ Identificati ${result.probed} dispositivi, ${result.errors} errori`);
        } else {
            alert('Errore: ' + (result.error || 'Identificazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        loading.style.display = 'none';
    }
}

async function importDiscoveredDevices() {
    const checkboxes = document.querySelectorAll('.disc-cb:checked');
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un dispositivo da importare');
        return;
    }
    
    const devices = [];
    checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        const dev = discoveredDevices[idx];
        const typeSelect = document.querySelector(`.disc-type[data-index="${idx}"]`);
        const deviceType = typeSelect ? typeSelect.value : (dev.identified_type || dev.suggested_type || 'other');
        
        if (dev) {
            // Passa TUTTI i dati raccolti durante la discovery all'import
            devices.push({
                address: dev.address,
                mac_address: dev.mac_address,
                name: dev.hostname || dev.identity || dev.address,
                hostname: dev.hostname || dev.identity,  // Hostname risolto via DNS
                identity: dev.hostname || dev.identity,
                platform: dev.vendor || dev.platform,
                board: dev.model || dev.board,
                device_type: deviceType,
                category: dev.category,
                open_ports: dev.open_ports || [],  // Porte TCP/UDP aperte
                os_family: dev.os_family,
                os_version: dev.os_version,
                identified_by: dev.identified_by,
                credential_used: dev.credential_used,
            });
            
            // Log per debug
            console.log(`Device ${dev.address}: hostname=${dev.hostname}, open_ports=${dev.open_ports?.filter(p => p.open)?.length || 0}`);
        }
    });
    
    if (!confirm(`Importare ${devices.length} dispositivi nell'inventario?`)) return;
    
    // Log dettagliato per debug
    console.log('Devices da importare:', JSON.stringify(devices, null, 2));
    
    try {
        const response = await fetch(`/api/v1/inventory/devices/bulk-import?customer_id=${customerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ devices })
        });
        const result = await response.json();
        console.log('Risultato import:', result);
        
        if (result.success) {
            alert(`‚úÖ Importati ${result.imported} dispositivi\n${result.skipped} duplicati\n${result.without_mac || 0} senza MAC (importati comunque)`);
            
            // Rimuovi importati dalla lista
            const importedIps = devices.map(d => d.address);
            discoveredDevices = discoveredDevices.filter(d => !importedIps.includes(d.address));
            
            if (discoveredDevices.length > 0) {
                renderDiscoveryResults();
                document.getElementById('discoveryDeviceCount').textContent = discoveredDevices.length;
            } else {
                document.getElementById('discoverySection').style.display = 'none';
            }
            
            // Ricarica inventario
            loadInventory();
        } else {
            alert('Errore: ' + (result.error || 'Import fallito'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// INVENTARIO
// ==========================================

// Memorizza le credenziali per il dropdown
let customerCredentials = [];

async function loadInventory() {
    const typeFilter = document.getElementById('inventoryTypeFilter')?.value || '';
    const loading = document.getElementById('inventoryLoading');
    const tbody = document.getElementById('inventoryBody');
    
    loading.style.display = 'block';
    
    try {
        // Carica credenziali se non gi√† caricate
        if (customerCredentials.length === 0) {
            const credResponse = await fetch(`/api/v1/customers/${customerId}/credentials`);
            const credData = await credResponse.json();
            customerCredentials = credData.credentials || [];
        }
        
        let url = `/api/v1/inventory/devices?customer_id=${customerId}`;
        if (typeFilter) url += `&device_type=${typeFilter}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        document.getElementById('inventoryCount').textContent = data.total || 0;
        tbody.innerHTML = '';

        if (!data.devices || data.devices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">Nessun dispositivo in inventario. Esegui una scansione sopra.</td></tr>';
        } else {
            // Helper function per determinare azioni device
            // Genera solo i pulsanti applicabili al tipo di dispositivo
            function getDeviceActionButtons(dev) {
                let buttons = '';
                const devType = (dev.device_type || '').toLowerCase();
                const osFamily = (dev.os_family || '').toLowerCase();
                const manufacturer = (dev.manufacturer || '').toLowerCase();
                const openPorts = dev.open_ports || '';
                
                // Verifica se √® MikroTik
                const isMikroTik = devType === 'mikrotik' || 
                                   osFamily.includes('routeros') ||
                                   openPorts.includes('8728') || 
                                   openPorts.includes('8729') || 
                                   openPorts.includes('8291');
                
                if (isMikroTik) {
                    buttons += '<button class="btn btn-outline-primary btn-sm" onclick="backupMikroTikDevice(\'' + dev.id + '\', \'' + (dev.primary_ip || '') + '\')" title="Backup Configurazione"><i class="bi bi-download"></i></button>';
                    buttons += '<button class="btn btn-outline-success btn-sm" onclick="manageMikroTikDevice(\'' + dev.id + '\', \'' + (dev.primary_ip || '') + '\')" title="Gestione MikroTik"><i class="bi bi-router"></i></button>';
                }
                
                // Verifica se √® HP/Aruba
                const isHPAruba = devType.includes('hp') || devType.includes('aruba') || devType.includes('procurve') ||
                                  manufacturer.includes('hp') || manufacturer.includes('aruba');
                
                if (isHPAruba) {
                    buttons += '<button class="btn btn-outline-primary btn-sm" onclick="backupHPArubaDevice(\'' + dev.id + '\', \'' + (dev.primary_ip || '') + '\')" title="Backup Configurazione"><i class="bi bi-download"></i></button>';
                    buttons += '<button class="btn btn-outline-info btn-sm" onclick="manageHPArubaDevice(\'' + dev.id + '\', \'' + (dev.primary_ip || '') + '\')" title="Info Switch"><i class="bi bi-ethernet"></i></button>';
                }
                
                // Verifica se √® Proxmox
                const isProxmox = devType === 'proxmox' || 
                                 osFamily.includes('proxmox') ||
                                 (dev.hostname && dev.hostname.toLowerCase().includes('proxmox')) ||
                                 (dev.name && dev.name.toLowerCase().includes('proxmox')) ||
                                 openPorts.includes('8006');
                
                if (isProxmox) {
                    buttons += '<button class="btn btn-outline-primary btn-sm" onclick="backupProxmoxDevice(\'' + dev.id + '\', \'' + (dev.primary_ip || '') + '\')" title="Backup Configurazione Proxmox"><i class="bi bi-download"></i></button>';
                }
                
                return buttons;
            }
            // Salva i dispositivi globalmente per l'ordinamento
            window.inventoryDevices = data.devices || [];
            
            // Inizializza variabili di ordinamento se non esistono
            if (window.inventorySortColumn === undefined) {
                window.inventorySortColumn = 1; // Default: ordina per IP
                window.inventorySortDirection = 'asc';
            }
            
            // Applica ordinamento salvato
            const sortedDevices = applyInventorySort([...window.inventoryDevices]);

            sortedDevices.forEach(dev => {
                const typeIcons = {
                    'mikrotik': '<i class="bi bi-router text-danger"></i>',
                    'windows': '<i class="bi bi-windows text-primary"></i>',
                    'linux': '<i class="bi bi-terminal text-warning"></i>',
                    'network': '<i class="bi bi-diagram-3 text-info"></i>',
                    'printer': '<i class="bi bi-printer text-secondary"></i>',
                    'camera': '<i class="bi bi-camera-video text-success"></i>',
                    'voip': '<i class="bi bi-telephone text-info"></i>',
                    'other': '<i class="bi bi-device-hdd text-muted"></i>'
                };
                const typeIcon = typeIcons[dev.device_type] || typeIcons['other'];
                
                // Icona occhio per stato riconoscimento
                // üü¢ Verde: identificato (identified_by o info hardware complete)
                // üü° Giallo: parziale (alcuni dati ma non completi)
                // üî¥ Rosso: solo scoperto (nessun dato significativo)
                let recognitionIcon = '';
                const hasIdentification = dev.identified_by && dev.identified_by !== '';
                const hasHardwareInfo = dev.cpu_model || dev.ram_total_gb || dev.serial_number;
                const hasOsInfo = dev.os_family || dev.os_version;
                const hasVendor = dev.manufacturer && dev.manufacturer !== '' && dev.manufacturer !== 'Unknown';
                
                if (hasIdentification || (hasHardwareInfo && hasOsInfo)) {
                    // Completamente riconosciuto
                    recognitionIcon = '<i class="bi bi-eye-fill text-success me-1" title="Identificato: ' + (dev.identified_by || 'hardware info') + '"></i>';
                } else if (hasOsInfo || hasVendor || hasHardwareInfo) {
                    // Parzialmente riconosciuto
                    recognitionIcon = '<i class="bi bi-eye-fill text-warning me-1" title="Parzialmente identificato"></i>';
                } else {
                    // Solo scoperto
                    recognitionIcon = '<i class="bi bi-eye text-danger me-1" title="Solo scoperto - richiede detect"></i>';
                }
                
                // Dropdown credenziali
                let credOptions = '<option value="">-- Nessuna --</option>';
                customerCredentials.forEach(cred => {
                    const selected = cred.id === dev.credential_id ? 'selected' : '';
                    const typeLabel = cred.credential_type ? ` (${cred.credential_type})` : '';
                    credOptions += `<option value="${cred.id}" ${selected}>${cred.name}${typeLabel}</option>`;
                });
                
                // Monitoraggio toggle - pulsante singolo per abilitare/disabilitare
                const isMonitored = dev.monitored || false;
                const monitoringType = dev.monitoring_type || 'none';
                const monitoringHtml = `
                    <button type="button" class="btn btn-sm ${isMonitored && monitoringType !== 'none' ? 'btn-success' : 'btn-outline-secondary'}" 
                            onclick="toggleMonitoring('${dev.id}')" 
                            title="${isMonitored && monitoringType !== 'none' ? 'Monitoraggio attivo' : 'Abilita monitoraggio'}">
                        <i class="bi ${isMonitored && monitoringType !== 'none' ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                    </button>
                `;

                // Servizi aperti
                let servicesDisplay = '<span class="text-muted small">-</span>';
                const devPorts = parseOpenPorts(dev.open_ports);
                if (devPorts.length > 0) {
                    const openServices = devPorts.filter(p => p.open);
                    if (openServices.length > 0) {
                        const serviceList = openServices.slice(0, 5).map(s =>
                            `<span class="badge bg-info" title="Port ${s.port}">${s.service}</span>`
                        ).join(' ');
                        const moreCount = openServices.length > 5 ? ` <small>(+${openServices.length - 5})</small>` : '';
                        servicesDisplay = serviceList + moreCount;
                    }
                }

                // Dropdown credenziali HTML
                const credSelect = `
                    <select class="form-select form-select-sm" style="width: 120px; font-size: 0.75rem;" 
                            onchange="updateDeviceCredential('${dev.id}', this.value)">
                        ${credOptions}
                    </select>
                `;

                // Migliora visualizzazione per VM Proxmox
                let deviceNameHtml = `${recognitionIcon}<strong>${dev.name}</strong>`;
                if (dev.name && dev.name.includes('(VM)')) {
                    deviceNameHtml = `${recognitionIcon}<i class="bi bi-cloud text-info me-1"></i><strong>${dev.name}</strong>`;
                    if (dev.description && dev.description.includes('Proxmox')) {
                        const vmType = dev.description.includes('LXC') ? 'LXC' : 'QEMU';
                        deviceNameHtml += `<br><small class="text-muted"><span class="badge bg-secondary">${vmType}</span></small>`;
                    }
                }
                if (dev.hostname && !dev.name.includes(dev.hostname)) {
                    deviceNameHtml += `<br><small class="text-muted">${dev.hostname}</small>`;
                }
                
                tbody.innerHTML += `
                    <tr data-device-id="${dev.id}">
                        <td>
                            ${deviceNameHtml}
                        </td>
                        <td><code class="small">${dev.primary_ip || '-'}</code></td>
                        <td><code class="small">${dev.mac_address || '-'}</code></td>
                        <td>
                            <input type="text" 
                                   class="form-control form-control-sm autocomplete-field" 
                                   data-device-id="${dev.id}" 
                                   data-field="device_type"
                                   data-api-endpoint="/api/v1/inventory/device-types"
                                   value="${dev.device_type || ''}" 
                                   placeholder="Tipo..."
                                   list="device-types-list-${dev.id}"
                                   style="min-width: 120px; font-size: 0.875rem;"
                                   onblur="updateDeviceFieldFromInput(this)"
                                   onkeypress="if(event.key==='Enter') this.blur()">
                            <datalist id="device-types-list-${dev.id}"></datalist>
                        </td>
                        <td>
                            <input type="text" 
                                   class="form-control form-control-sm autocomplete-field" 
                                   data-device-id="${dev.id}" 
                                   data-field="category"
                                   data-api-endpoint="/api/v1/inventory/categories"
                                   value="${dev.category || ''}" 
                                   placeholder="Categoria..."
                                   list="categories-list-${dev.id}"
                                   style="min-width: 120px; font-size: 0.875rem;"
                                   onblur="updateDeviceFieldFromInput(this)"
                                   onkeypress="if(event.key==='Enter') this.blur()">
                            <datalist id="categories-list-${dev.id}"></datalist>
                        </td>
                        <td>
                            <input type="text" 
                                   class="form-control form-control-sm autocomplete-field" 
                                   data-device-id="${dev.id}" 
                                   data-field="os_family"
                                   data-api-endpoint="/api/v1/inventory/os-families"
                                   value="${dev.os_family || ''}" 
                                   placeholder="OS..."
                                   list="os-families-list-${dev.id}"
                                   style="min-width: 120px; font-size: 0.875rem;"
                                   onblur="updateDeviceFieldFromInput(this)"
                                   onkeypress="if(event.key==='Enter') this.blur()">
                            <datalist id="os-families-list-${dev.id}"></datalist>
                        </td>
                        <td>
                            <input type="text" 
                                   class="form-control form-control-sm autocomplete-field" 
                                   data-device-id="${dev.id}" 
                                   data-field="manufacturer"
                                   data-api-endpoint="/api/v1/inventory/manufacturers"
                                   value="${dev.manufacturer || ''}" 
                                   placeholder="Vendor..."
                                   list="manufacturers-list-${dev.id}"
                                   style="min-width: 120px; font-size: 0.875rem;"
                                   onblur="updateDeviceFieldFromInput(this)"
                                   onkeypress="if(event.key==='Enter') this.blur()">
                            <datalist id="manufacturers-list-${dev.id}"></datalist>
                        </td>
                        <td style="min-width: 120px;">${servicesDisplay}</td>
                        <td>${credSelect}</td>
                        <td>${monitoringHtml}</td>
                        <td>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info" onclick="viewInventoryDevice('${dev.id}')" title="Dettagli">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-warning" onclick="autoDetectDevice('${dev.id}', '${dev.primary_ip}')" title="Auto-Detect">
                                        <i class="bi bi-bullseye"></i>
                                    </button>
                                    ${getDeviceActionButtons(dev)}
                                </div>
                                <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteInventoryDevice('${dev.id}')" title="Elimina">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Debug: log dei dati del device
                const debugPorts = parseOpenPorts(dev.open_ports);
                if (debugPorts.length > 0) {
                    console.log(`Device ${dev.name} (${dev.primary_ip}): ${debugPorts.filter(p => p.open).length} porte aperte`);
                }
                if (dev.hostname) {
                    console.log(`Device ${dev.name}: hostname = ${dev.hostname}`);
                }
            });
            
            // Aggiorna icone di ordinamento
            updateSortIcons();
            
            // Popola i datalist per autocompletamento
            await populateAllDatalists();
        }
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="13" class="text-center py-4 text-danger">Errore: ${e.message}</td></tr>`;
    } finally {
        loading.style.display = 'none';
    }
}

async function loadDuplicates() {
    const loading = document.getElementById('duplicatesLoading');
    const content = document.getElementById('duplicatesContent');
    
    loading.style.display = 'block';
    content.innerHTML = '';
    
    try {
        const response = await fetch(`/api/v1/customers/${customerId}/devices/duplicates`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('duplicatesCount').textContent = data.total_groups || 0;
            
            if (data.duplicate_groups && data.duplicate_groups.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
                html += '<th>Gruppo</th><th>Device</th><th>IP</th><th>MAC</th><th>Hostname</th><th>Ultima Verifica</th><th>Verifiche</th><th>Azioni</th>';
                html += '</tr></thead><tbody>';
                
                data.duplicate_groups.forEach((group, groupIdx) => {
                    group.devices.forEach((device, deviceIdx) => {
                        html += '<tr>';
                        if (deviceIdx === 0) {
                            html += `<td rowspan="${group.count}" class="align-middle"><strong>Gruppo ${groupIdx + 1}</strong><br><small class="text-muted">${group.count} device</small></td>`;
                        }
                        html += `<td>${device.name || '-'}</td>`;
                        html += `<td><code>${device.primary_ip || '-'}</code></td>`;
                        html += `<td><code>${device.mac_address || '-'}</code></td>`;
                        html += `<td>${device.hostname || '-'}</td>`;
                        html += `<td>${device.last_verified_at ? new Date(device.last_verified_at).toLocaleDateString() : 'Mai'}</td>`;
                        html += `<td><span class="badge bg-info">${device.verification_count || 0}</span></td>`;
                        if (deviceIdx === 0) {
                            html += `<td rowspan="${group.count}" class="align-middle">`;
                            html += `<button class="btn btn-sm btn-primary" onclick="mergeDuplicateGroup(${groupIdx}, [${group.devices.map(d => `'${d.id}'`).join(',')}])">Merge</button>`;
                            html += '</td>';
                        }
                        html += '</tr>';
                    });
                });
                
                html += '</tbody></table></div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = '<p class="text-muted text-center py-4">Nessun duplicato trovato.</p>';
            }
        } else {
            content.innerHTML = `<p class="text-danger text-center py-4">Errore: ${data.detail || data.error || 'Errore sconosciuto'}</p>`;
        }
    } catch (e) {
        content.innerHTML = `<p class="text-danger text-center py-4">Errore: ${e.message}</p>`;
    } finally {
        loading.style.display = 'none';
    }
}

async function mergeDuplicateGroup(groupIdx, deviceIds) {
    if (deviceIds.length < 2) {
        alert('Serve almeno 2 device per fare merge');
        return;
    }
    
    const targetId = deviceIds[0];
    const sourceIds = deviceIds.slice(1);
    
    if (!confirm(`Vuoi mergiare ${sourceIds.length} device nel device principale (${targetId})?`)) {
        return;
    }
    
    try {
        for (const sourceId of sourceIds) {
            const response = await fetch(`/api/v1/customers/${customerId}/devices/${sourceId}/merge`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_device_id: targetId,
                    merge_strategy: 'merge'
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                alert(`Errore merge device ${sourceId}: ${result.detail || result.error}`);
                return;
            }
        }
        
        alert('Merge completato con successo!');
        loadDuplicates();
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Funzione helper per applicare l'ordinamento
function applyInventorySort(devices) {
    if (!devices || devices.length === 0) return devices;
    
    const columnIndex = window.inventorySortColumn ?? 1;
    const direction = window.inventorySortDirection ?? 'asc';
    
    return devices.sort((a, b) => {
        let valA, valB;
        let compareResult = 0;
        
        switch(columnIndex) {
            case 0: // Nome
                valA = (a.name || '').toLowerCase();
                valB = (b.name || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 1: // IP
                const ipA = (a.primary_ip || '').split('.').map(num => parseInt(num || 0, 10));
                const ipB = (b.primary_ip || '').split('.').map(num => parseInt(num || 0, 10));
                for (let i = 0; i < 4; i++) {
                    if (ipA[i] !== ipB[i]) {
                        compareResult = ipA[i] - ipB[i];
                        break;
                    }
                }
                break;
            case 2: // MAC
                valA = (a.mac_address || '').toLowerCase();
                valB = (b.mac_address || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 3: // Tipo
                valA = (a.device_type || '').toLowerCase();
                valB = (b.device_type || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 4: // Categoria
                valA = (a.category || '').toLowerCase();
                valB = (b.category || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 5: // OS
                valA = (a.os_family || '').toLowerCase();
                valB = (b.os_family || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 6: // Vendor
                valA = (a.manufacturer || '').toLowerCase();
                valB = (b.manufacturer || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            case 10: // Stato
                valA = (a.status || '').toLowerCase();
                valB = (b.status || '').toLowerCase();
                compareResult = valA < valB ? -1 : (valA > valB ? 1 : 0);
                break;
            default:
                return 0;
        }
        
        return direction === 'asc' ? compareResult : -compareResult;
    });
}

// Funzione per ordinare la tabella inventario
function sortInventoryTable(columnIndex, sortType) {
    if (!window.inventoryDevices || window.inventoryDevices.length === 0) return;
    
    // Cambia direzione se stessa colonna
    if (window.inventorySortColumn === columnIndex) {
        window.inventorySortDirection = window.inventorySortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        window.inventorySortColumn = columnIndex;
        window.inventorySortDirection = 'asc';
    }
    
    // Ordina i dispositivi
    const sorted = applyInventorySort([...window.inventoryDevices]);
    
    // Riordina le righe esistenti invece di ricaricare
    const tbody = document.getElementById('inventoryBody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-device-id]'));
    
    // Ordina le righe DOM in base all'ordine dei dispositivi
    const deviceIdMap = new Map(sorted.map((dev, idx) => [dev.id, idx]));
    rows.sort((rowA, rowB) => {
        const idA = rowA.getAttribute('data-device-id');
        const idB = rowB.getAttribute('data-device-id');
        const idxA = deviceIdMap.get(idA) ?? 9999;
        const idxB = deviceIdMap.get(idB) ?? 9999;
        return idxA - idxB;
    });
    
    // Rimuovi e riaggiungi le righe nell'ordine corretto
    rows.forEach(row => tbody.appendChild(row));
    
    updateSortIcons();
}

// Aggiorna le icone di ordinamento
function updateSortIcons() {
    const headers = document.querySelectorAll('#inventoryTable thead th');
    headers.forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (icon) {
            if (window.inventorySortColumn === index) {
                icon.className = window.inventorySortDirection === 'asc' 
                    ? 'bi bi-arrow-up sort-icon text-primary' 
                    : 'bi bi-arrow-down sort-icon text-primary';
                icon.style.opacity = '1';
            } else {
                icon.className = 'bi bi-arrow-down-up sort-icon';
                icon.style.opacity = '0.3';
            }
        }
    });
}

// Aggiungi stili CSS per le intestazioni cliccabili
if (!document.getElementById('inventoryTableSortStyles')) {
    const style = document.createElement('style');
    style.id = 'inventoryTableSortStyles';
    style.textContent = `
        #inventoryTable thead th[onclick] {
            user-select: none;
            position: relative;
        }
        #inventoryTable thead th[onclick]:hover {
            background-color: rgba(0,0,0,0.05);
        }
        #inventoryTable thead th .sort-icon {
            margin-left: 4px;
            font-size: 0.8em;
            transition: opacity 0.2s;
        }
    `;
    document.head.appendChild(style);
}

async function clearInventory() {
    if (!confirm('‚ö†Ô∏è ATTENZIONE: Questa operazione eliminer√† TUTTI i dispositivi dall\'inventario di questo cliente.\n\nSei sicuro di voler continuare?')) {
        return;
    }

    if (!confirm('Conferma nuovamente: eliminare TUTTI i dispositivi?')) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/inventory/devices/clear?customer_id=${customerId}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
            alert(`‚úÖ Inventario svuotato: ${result.deleted} dispositivi eliminati`);
            await loadInventory();
        } else {
            alert('Errore: ' + (result.error || 'Eliminazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateDeviceCredential(deviceId, credentialId) {
    try {
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential_id: credentialId || null })
        });
        
        const result = await response.json();
        if (!result.success) {
            alert('Errore aggiornamento credenziale');
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function probeDevice(deviceId, ip) {
    if (!ip) {
        alert('Dispositivo senza IP, impossibile identificare');
        return;
    }
    
    // Trova la credenziale associata al device
    const row = event.target.closest('tr');
    const credSelect = row.querySelector('select');
    const credentialId = credSelect ? credSelect.value : null;
    
    // Se non c'√® credenziale selezionata, usa tutte le credenziali attive
    let credIds = credentialId ? [credentialId] : customerCredentials.map(c => c.id);
    
    if (credIds.length === 0) {
        alert('Nessuna credenziale disponibile. Aggiungi credenziali prima di identificare.');
        return;
    }
    
    // Mostra loading
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    try {
        // Usa il nuovo endpoint che identifica e aggiorna automaticamente
        const params = new URLSearchParams();
        credIds.forEach(id => params.append('credential_ids', id));
        
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}/identify?${params}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            const probe = result.probe_result;

            // Crea messaggio dettagliato
            let message = `‚úÖ Identificazione Completata\n\n`;
            message += `üîç Identificato da: ${probe.identified_by || 'unknown'}\n`;
            message += `üíæ Credenziale usata: ${probe.credential_used || 'N/A'}\n\n`;
            message += `üìã Dettagli Rilevati:\n`;
            message += `‚Ä¢ Tipo: ${probe.device_type || 'unknown'}\n`;
            message += `‚Ä¢ Categoria: ${probe.category || 'N/A'}\n`;
            message += `‚Ä¢ OS: ${probe.os_family || 'unknown'} ${probe.os_version || ''}\n`;
            message += `‚Ä¢ Hostname: ${probe.hostname || 'N/A'}\n`;
            message += `‚Ä¢ Modello: ${probe.model || 'N/A'}\n`;
            message += `‚Ä¢ Vendor: ${probe.vendor || 'N/A'}\n`;

            if (result.updates_applied && result.updates_applied.length > 0) {
                message += `\n‚ú® Campi aggiornati: ${result.updates_applied.join(', ')}`;
            } else {
                message += `\n‚ö†Ô∏è Nessun campo aggiornato (dati gi√† presenti)`;
            }

            // Mostra protocolli testati
            if (probe.probe_results && probe.probe_results.length > 0) {
                message += `\n\nüîå Protocolli Testati:`;
                probe.probe_results.forEach(p => {
                    const icon = p.success ? '‚úÖ' : '‚ùå';
                    message += `\n  ${icon} ${p.protocol}: ${p.error || 'OK'}`;
                });
            }

            alert(message);
            loadInventory();
        } else {
            // Errore dettagliato
            let errorMsg = '‚ùå Identificazione Fallita\n\n';
            if (result.probe_result) {
                const probe = result.probe_result;
                if (probe.probe_results && probe.probe_results.length > 0) {
                    errorMsg += 'Protocolli testati:\n';
                    probe.probe_results.forEach(p => {
                        errorMsg += `\n‚Ä¢ ${p.protocol}: ${p.error || 'fallito'}`;
                    });
                }
            } else {
                errorMsg += result.detail || result.message || 'Errore sconosciuto';
            }
            alert(errorMsg);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function scanPorts(deviceId, ip) {
    if (!ip) {
        alert('Dispositivo senza IP, impossibile scansionare le porte');
        return;
    }
    
    // Mostra loading
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}/scan-ports`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            const openPorts = parseOpenPorts(result.open_ports).filter(p => p.open);
            let message = `‚úÖ Scansione Porte Completata\n\n`;
            message += `üìç IP: ${ip}\n`;
            message += `üîå Porte Aperte: ${result.open_count}\n\n`;
            
            if (openPorts.length > 0) {
                message += `Porte rilevate:\n`;
                openPorts.forEach(p => {
                    message += `‚Ä¢ ${p.port}/${p.protocol} - ${p.service || 'unknown'}\n`;
                });
            } else {
                message += `Nessuna porta aperta rilevata`;
            }
            
            alert(message);
            loadInventory(); // Ricarica per mostrare le porte aggiornate
        } else {
            alert('‚ùå Errore durante la scansione: ' + (result.detail || result.message || 'Errore sconosciuto'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function batchScanPorts() {
    if (!confirm('Vuoi scansionare le porte di TUTTI i dispositivi inventariati di questo cliente?\n\nQuesta operazione potrebbe richiedere alcuni minuti.')) {
        return;
    }
    
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scansione in corso...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/v1/inventory/devices/batch-scan-ports?customer_id=${customerId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            let message = `‚úÖ Scansione Batch Completata\n\n`;
            message += `üìä Totale dispositivi: ${result.total}\n`;
            message += `‚úÖ Scansionati con successo: ${result.scanned}\n`;
            
            if (result.errors && result.errors.length > 0) {
                message += `\n‚ùå Errori: ${result.errors.length}\n`;
                if (result.errors.length <= 5) {
                    result.errors.forEach(e => message += `‚Ä¢ ${e}\n`);
                } else {
                    result.errors.slice(0, 5).forEach(e => message += `‚Ä¢ ${e}\n`);
                    message += `... e altri ${result.errors.length - 5} errori\n`;
                }
            }
            
            alert(message);
            loadInventory(); // Ricarica per mostrare le porte aggiornate
        } else {
            alert('‚ùå Errore durante la scansione batch: ' + (result.detail || result.message || 'Errore sconosciuto'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Auto-Detect singolo dispositivo usando credenziali di default
async function autoDetectDevice(deviceId, address) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/v1/inventory/auto-detect?customer_id=${customerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                address: address,
                device_id: deviceId,  // ID device per usare credenziali assegnate e salvare risultati
                use_assigned_credential: true,  // Priorit√† a credenziale assegnata al device
                use_default_credentials: true,  // Fallback a credenziali default
                use_agent: true,  // Usa agent se disponibile
                save_results: true  // Salva risultati nel device
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.scan_result) {
            const sr = result.scan_result;
            let message = '‚úÖ Auto-Detect Completato!\n\n';
            message += `Indirizzo: ${address}\n`;
            message += `Tipo: ${sr.device_type || 'unknown'}\n`;
            message += `Categoria: ${sr.category || 'N/A'}\n`;
            message += `Hostname: ${sr.hostname || sr.sysName || 'N/A'}\n`;
            message += `OS: ${sr.os_name || sr.os_family || 'N/A'}\n`;
            message += `Versione: ${sr.os_version || sr.version || 'N/A'}\n`;
            message += `Vendor: ${sr.vendor || sr.manufacturer || 'N/A'}\n`;
            message += `Modello: ${sr.model || 'N/A'}\n`;
            message += `Serial: ${sr.serial_number || 'N/A'}\n`;
            
            if (sr.cpu_model) message += `CPU: ${sr.cpu_model} (${sr.cpu_cores || '?'} cores)\n`;
            if (sr.memory_total_mb || sr.ram_total_mb) message += `RAM: ${sr.memory_total_mb || sr.ram_total_mb} MB\n`;
            if (sr.disk_total_gb) message += `Disco: ${sr.disk_total_gb} GB\n`;
            
            message += `\nIdentificato via: ${sr.identified_by || 'N/A'}\n`;
            
            if (result.credentials_tested && result.credentials_tested.length > 0) {
                message += `\nCredenziali testate:\n`;
                result.credentials_tested.forEach(c => {
                    message += `  ‚Ä¢ ${c.name} (${c.type})\n`;
                });
            }
            
            const resultPorts = parseOpenPorts(result.open_ports);
            if (resultPorts.length > 0) {
                const openPorts = resultPorts.filter(p => p.open).map(p => p.port);
                message += `\nPorte aperte: ${openPorts.join(', ')}\n`;
            }
            
            if (result.agent_used) {
                message += `\nAgent usato: ${result.agent_used.name} (${result.agent_used.type})\n`;
            }
            
            if (result.saved) {
                message += `\nüíæ Dati salvati nel dispositivo!\n`;
            } else if (result.save_error) {
                message += `\n‚ö†Ô∏è Errore salvataggio: ${result.save_error}\n`;
            }
            
            alert(message);
            
            // Ricarica l'inventario per vedere i dati aggiornati
            loadInventory();
        } else {
            let errorMsg = '‚ùå Auto-Detect Fallito\n\n';
            errorMsg += `Indirizzo: ${address}\n`;
            errorMsg += `Errore: ${result.error || 'Nessuna informazione ottenuta'}\n`;
            
            const errorPorts = parseOpenPorts(result.open_ports);
            if (errorPorts.length > 0) {
                const openPorts = errorPorts.filter(p => p.open).map(p => p.port);
                errorMsg += `\nPorte aperte rilevate: ${openPorts.join(', ')}\n`;
            }
            
            if (result.credentials_tested && result.credentials_tested.length > 0) {
                errorMsg += `\nCredenziali testate senza successo:\n`;
                result.credentials_tested.forEach(c => {
                    const source = c.source === 'device_assigned' ? '[device]' : '[default]';
                    errorMsg += `  ‚Ä¢ ${c.name} (${c.type}) ${source}\n`;
                });
            } else {
                errorMsg += `\n‚ö†Ô∏è Nessuna credenziale trovata.\n`;
                errorMsg += `Assicurati che:\n`;
                errorMsg += `  1. Il device abbia una credenziale assegnata, oppure\n`;
                errorMsg += `  2. Esistano credenziali globali/cliente di default per i tipi richiesti\n`;
                errorMsg += `     (SSH/SNMP/WMI in base alle porte aperte)\n`;
            }
            
            alert(errorMsg);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Auto-Detect batch su tutti i dispositivi dell'inventario
async function batchAutoDetect() {
    if (!confirm('Eseguire Auto-Detect su TUTTI i dispositivi dell\'inventario?\n\nQuesta operazione:\n‚Ä¢ Scansiona le porte di ogni dispositivo\n‚Ä¢ Determina il tipo di credenziali da usare (WMI/SSH/SNMP)\n‚Ä¢ Prova le credenziali di default del cliente\n‚Ä¢ Aggiorna le informazioni raccolte\n\nPotrebbe richiedere diversi minuti.')) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Elaborazione...';
    btn.disabled = true;
    
    try {
        // Ottieni lista dispositivi
        const listResponse = await fetch(`/api/v1/inventory/devices?customer_id=${customerId}`);
        const listData = await listResponse.json();
        
        if (!listData.devices || listData.devices.length === 0) {
            alert('Nessun dispositivo in inventario');
            return;
        }
        
        const devices = listData.devices;
        let successCount = 0;
        let failCount = 0;
        let results = [];
        
        // Processa ogni dispositivo
        for (let i = 0; i < devices.length; i++) {
            const dev = devices[i];
            btn.innerHTML = `<i class="bi bi-hourglass-split"></i> ${i+1}/${devices.length}...`;
            
            if (!dev.primary_ip) {
                results.push({ address: dev.name, success: false, error: 'No IP' });
                failCount++;
                continue;
            }
            
            try {
                const response = await fetch(`/api/v1/inventory/auto-detect?customer_id=${customerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: dev.primary_ip,
                        mac_address: dev.mac_address,
                        use_default_credentials: true,
                        use_agent: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.identified) {
                    // Aggiorna dispositivo
                    await fetch(`/api/v1/inventory/devices/${dev.id}/identify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ probe_result: result.scan_result })
                    });
                    
                    results.push({ 
                        address: dev.primary_ip, 
                        success: true, 
                        type: result.scan_result.device_type,
                        hostname: result.scan_result.hostname || result.scan_result.sysName,
                        method: result.scan_result.identified_by
                    });
                    successCount++;
                } else {
                    results.push({ 
                        address: dev.primary_ip, 
                        success: false, 
                        error: result.error || 'Non identificato' 
                    });
                    failCount++;
                }
            } catch (e) {
                results.push({ address: dev.primary_ip, success: false, error: e.message });
                failCount++;
            }
        }
        
        // Mostra risultato
        let message = `‚úÖ Auto-Detect Batch Completato!\n\n`;
        message += `Totale: ${devices.length}\n`;
        message += `Identificati: ${successCount}\n`;
        message += `Falliti: ${failCount}\n\n`;
        
        if (successCount > 0) {
            message += `Dispositivi identificati:\n`;
            results.filter(r => r.success).slice(0, 10).forEach(r => {
                message += `  ‚úì ${r.address}: ${r.hostname || r.type} (${r.method})\n`;
            });
            if (successCount > 10) message += `  ... e altri ${successCount - 10}\n`;
        }
        
        if (failCount > 0 && failCount <= 5) {
            message += `\nDispositivi non identificati:\n`;
            results.filter(r => !r.success).forEach(r => {
                message += `  ‚úó ${r.address}: ${r.error}\n`;
            });
        }
        
        alert(message);
        loadInventory();
        
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function deleteInventoryDevice(deviceId) {
    if (!confirm('Eliminare questo dispositivo dall\'inventario?')) return;
    
    try {
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (result.success) {
            loadInventory();
        } else {
            alert('Errore: ' + (result.error || 'Eliminazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// MONITORAGGIO
// ==========================================

async function toggleMonitoring(deviceId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    try {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;
        
        // Determina lo stato attuale del dispositivo
        const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
        const isCurrentlyMonitored = btn.classList.contains('btn-success');
        const newMonitoringType = isCurrentlyMonitored ? 'none' : 'agent'; // Usa 'agent' come default quando si abilita
        
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}/monitoring`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                monitoring_type: newMonitoringType,
                customer_id: customerId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Aggiorna visivamente il pulsante
            if (newMonitoringType === 'none') {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                btn.innerHTML = '<i class="bi bi-toggle-off"></i>';
                btn.title = 'Abilita monitoraggio';
            } else {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                btn.innerHTML = '<i class="bi bi-toggle-on"></i>';
                btn.title = 'Monitoraggio attivo';
            }
            
            // Mostra messaggio se configurato Netwatch
            if (result.netwatch_configured) {
                console.log(`Netwatch configurato su ${result.mikrotik_name || 'MikroTik'} per ${result.device_ip}`);
            }
        } else {
            alert('Errore: ' + (result.error || result.message || 'Configurazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Configura monitoraggio per pi√π dispositivi
async function batchSetMonitoring(enable) {
    const checkboxes = document.querySelectorAll('#inventoryTable input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert('Seleziona almeno un dispositivo');
        return;
    }
    
    const deviceIds = Array.from(checkboxes).map(cb => cb.dataset.deviceId);
    const monitoringType = enable ? 'agent' : 'none';
    
    if (!confirm(`${enable ? 'Abilitare' : 'Disabilitare'} monitoraggio per ${deviceIds.length} dispositivi?`)) return;
    
    for (const deviceId of deviceIds) {
        try {
            const response = await fetch(`/api/v1/inventory/devices/${deviceId}/monitoring`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    monitoring_type: monitoringType,
                    customer_id: customerId
                })
            });
            await response.json();
        } catch (e) {
            console.error(`Errore dispositivo ${deviceId}:`, e);
        }
    }
    
    alert(`Monitoraggio ${enable ? 'abilitato' : 'disabilitato'} per ${deviceIds.length} dispositivi`);
    loadInventory();
}

async function addToDude(deviceId) {
    if (!confirm('Aggiungere questo dispositivo a The Dude per il monitoraggio?')) return;
    
    try {
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}/add-to-dude`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Dispositivo aggiunto a The Dude');
            loadInventory();
        } else {
            alert('Errore: ' + (result.message || 'Aggiunta fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function viewInventoryDevice(deviceId) {
    try {
        // Carica dettagli dispositivo
        const response = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await response.json();

        if (!device) {
            alert('Dispositivo non trovato');
            return;
        }

        // Crea contenuto modal
        let detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Informazioni Generali</h6>
                    <table class="table table-sm">
                        <tr><th width="40%">Nome:</th><td>${device.name || '-'}</td></tr>
                        <tr><th>Hostname:</th><td>${device.hostname || '-'}</td></tr>
                        <tr><th>Dominio:</th><td>${device.domain || '-'}</td></tr>
                        <tr><th>IP Primario:</th><td>${device.primary_ip || '-'}</td></tr>
                        <tr><th>MAC Primario:</th><td>${device.primary_mac || '-'}</td></tr>
                        <tr><th>Tipo:</th><td><span class="badge bg-info">${device.device_type || 'other'}</span></td></tr>
                        <tr><th>Categoria:</th><td>${device.category || '-'}</td></tr>
                        <tr><th>Stato:</th><td><span class="badge bg-${device.status === 'online' ? 'success' : device.status === 'offline' ? 'danger' : 'secondary'}">${device.status || 'unknown'}</span></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Hardware & Sistema</h6>
                    <table class="table table-sm">
                        <tr><th width="40%">Produttore:</th><td>${device.manufacturer || '-'}</td></tr>
                        <tr><th>Modello:</th><td>${device.model || '-'}</td></tr>
                        <tr><th>Seriale:</th><td>${device.serial_number || '-'}</td></tr>
                        <tr><th>OS:</th><td>${device.os_family || '-'} ${device.os_version || ''}</td></tr>
                        <tr><th>CPU:</th><td>${device.cpu_model || '-'} ${device.cpu_cores ? '(' + device.cpu_cores + ' cores)' : ''}</td></tr>
                        <tr><th>RAM:</th><td>${device.ram_total_gb ? device.ram_total_gb + ' GB' : '-'}</td></tr>
                        <tr><th>Ultima vista:</th><td>${device.last_seen ? new Date(device.last_seen).toLocaleString('it-IT') : '-'}</td></tr>
                    </table>
                </div>
            </div>
        `;

        // Interfacce di rete
        if (device.network_interfaces && device.network_interfaces.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Interfacce di Rete (${device.network_interfaces.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>MAC</th>
                                <th>IP</th>
                                <th>Velocit√†</th>
                                <th>Stato</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            device.network_interfaces.forEach(nic => {
                const ips = nic.ip_addresses ? JSON.parse(nic.ip_addresses).map(ip => ip.ip || ip).join(', ') : '-';
                detailsHtml += `
                    <tr>
                        <td><code>${nic.name}</code></td>
                        <td><small>${nic.mac_address || '-'}</small></td>
                        <td><small>${ips}</small></td>
                        <td>${nic.speed_mbps ? nic.speed_mbps + ' Mbps' : '-'}</td>
                        <td><span class="badge bg-${nic.admin_status === 'up' ? 'success' : 'secondary'}">${nic.admin_status || '-'}</span></td>
                    </tr>
                `;
            });
            detailsHtml += '</tbody></table></div>';
        }

        // Dischi
        if (device.disks && device.disks.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Dischi (${device.disks.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Mount Point</th>
                                <th>Filesystem</th>
                                <th>Dimensione</th>
                                <th>Utilizzato</th>
                                <th>Uso %</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            device.disks.forEach(disk => {
                const usedPercent = disk.percent_used || (disk.size_gb && disk.used_gb ? Math.round((disk.used_gb / disk.size_gb) * 100) : 0);
                const progressColor = usedPercent > 90 ? 'danger' : usedPercent > 75 ? 'warning' : 'success';
                detailsHtml += `
                    <tr>
                        <td><code>${disk.name}</code></td>
                        <td>${disk.mount_point || '-'}</td>
                        <td>${disk.filesystem || '-'}</td>
                        <td>${disk.size_gb ? disk.size_gb.toFixed(1) + ' GB' : '-'}</td>
                        <td>${disk.used_gb ? disk.used_gb.toFixed(1) + ' GB' : '-'}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-${progressColor}" style="width: ${usedPercent}%">${usedPercent}%</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            detailsHtml += '</tbody></table></div>';
        }

        // Dettagli specifici per tipo
        if (device.windows_details) {
            const wd = device.windows_details;
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Dettagli Windows</h6>
                <table class="table table-sm">
                    <tr><th width="30%">Edizione:</th><td>${wd.edition || '-'}</td></tr>
                    <tr><th>Ruolo Dominio:</th><td>${wd.domain_role || '-'}</td></tr>
                    <tr><th>Dominio:</th><td>${wd.domain_name || '-'}</td></tr>
                    <tr><th>Antivirus:</th><td>${wd.antivirus_name || '-'} <span class="badge bg-${wd.antivirus_status === 'active' ? 'success' : 'warning'}">${wd.antivirus_status || '-'}</span></td></tr>
                    <tr><th>Ultimo Update:</th><td>${wd.last_update_check ? new Date(wd.last_update_check).toLocaleString('it-IT') : '-'}</td></tr>
                </table>
            `;
        }

        if (device.linux_details) {
            const ld = device.linux_details;
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Dettagli Linux</h6>
                <table class="table table-sm">
                    <tr><th width="30%">Distribuzione:</th><td>${ld.distro_name || '-'} ${ld.distro_version || ''}</td></tr>
                    <tr><th>Kernel:</th><td>${ld.kernel_version || '-'}</td></tr>
                    <tr><th>Package Manager:</th><td>${ld.package_manager || '-'}</td></tr>
                    <tr><th>Docker:</th><td>${ld.docker_installed ? '‚úÖ Installato (v' + (ld.docker_version || '-') + ')' : '‚ùå Non installato'}</td></tr>
                    <tr><th>Container Attivi:</th><td>${ld.containers_running || 0}</td></tr>
                    <tr><th>Uptime:</th><td>${ld.uptime_days ? ld.uptime_days.toFixed(1) + ' giorni' : '-'}</td></tr>
                </table>
            `;
        }

        if (device.mikrotik_details) {
            const md = device.mikrotik_details;
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Dettagli MikroTik RouterOS</h6>
                <table class="table table-sm">
                    <tr><th width="30%">RouterOS:</th><td>${md.routeros_version || '-'} (${md.routeros_channel || '-'})</td></tr>
                    <tr><th>Board:</th><td>${md.board_name || '-'}</td></tr>
                    <tr><th>Licenza:</th><td>${md.license_level || '-'}</td></tr>
                    <tr><th>Identity:</th><td>${md.identity || '-'}</td></tr>
                    <tr><th>CPU Load:</th><td>${md.cpu_load ? md.cpu_load + '%' : '-'}</td></tr>
                    <tr><th>Memoria Libera:</th><td>${md.memory_free_mb ? md.memory_free_mb + ' MB' : '-'}</td></tr>
                    <tr><th>Uptime:</th><td>${md.uptime || '-'}</td></tr>
                    <tr><th>Dude Agent:</th><td>${md.dude_agent_enabled ? '‚úÖ Abilitato (' + (md.dude_agent_status || 'unknown') + ')' : '‚ùå Disabilitato'}</td></tr>
                </table>
            `;
        }

        // Parse custom_fields for extra data
        let cf = {};
        if (device.custom_fields) {
            if (typeof device.custom_fields === 'string') {
                try {
                    cf = JSON.parse(device.custom_fields);
                } catch (e) {
                    console.warn('Error parsing custom_fields as JSON:', e);
                    cf = {};
                }
            } else if (typeof device.custom_fields === 'object' && device.custom_fields !== null) {
                cf = device.custom_fields;
            }
        }
        console.log('Parsed custom_fields:', Object.keys(cf), 'running_services:', cf.running_services ? cf.running_services.length : 'not present');
        
        // Determina se mostrare tab avanzate
        // Converti sempre in stringa per evitare errori con operatori 'in'
        let deviceType = '';
        let manufacturer = '';
        let osFamily = '';
        
        try {
            deviceType = device.device_type ? String(device.device_type).toLowerCase() : '';
            manufacturer = device.manufacturer ? String(device.manufacturer).toLowerCase() : '';
            osFamily = device.os_family ? String(device.os_family).toLowerCase() : '';
        } catch (e) {
            console.warn('Error converting device fields to string:', e);
        }
        
        // Verifica se √® un dispositivo di rete (switch/router)
        const isNetworkDevice = ['network', 'router', 'switch'].includes(deviceType) || 
                               (manufacturer && typeof manufacturer === 'string' && manufacturer.length > 0 && (
                                   manufacturer.indexOf('mikrotik') !== -1 || 
                                   manufacturer.indexOf('cisco') !== -1 || 
                                   manufacturer.indexOf('hp') !== -1 || 
                                   manufacturer.indexOf('aruba') !== -1 || 
                                   manufacturer.indexOf('ubiquiti') !== -1
                               ));
        
        // Verifica se √® Proxmox
        const isProxmox = deviceType === 'hypervisor' || 
                         (manufacturer && typeof manufacturer === 'string' && manufacturer.length > 0 && manufacturer.indexOf('proxmox') !== -1) || 
                         (osFamily && typeof osFamily === 'string' && osFamily.length > 0 && osFamily.indexOf('proxmox') !== -1);
        
        // Crea struttura con tab Bootstrap
        let modalContent = `
            <ul class="nav nav-tabs mb-3" id="deviceDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                        <i class="bi bi-info-circle"></i> Generale
                    </button>
                </li>
                ${device.network_interfaces && device.network_interfaces.length > 0 ? `
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="interfaces-tab" data-bs-toggle="tab" data-bs-target="#interfaces" type="button" role="tab">
                        <i class="bi bi-ethernet"></i> Interfacce
                    </button>
                </li>
                ` : ''}
                ${device.disks && device.disks.length > 0 ? `
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="disks-tab" data-bs-toggle="tab" data-bs-target="#disks" type="button" role="tab">
                        <i class="bi bi-hdd"></i> Dischi
                    </button>
                </li>
                ` : ''}
                ${isNetworkDevice ? `
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="neighbors-tab" data-bs-toggle="tab" data-bs-target="#neighbors" type="button" role="tab" onclick="loadDeviceNeighbors('${deviceId}')">
                        <i class="bi bi-diagram-3"></i> Neighbor
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="advanced-interfaces-tab" data-bs-toggle="tab" data-bs-target="#advanced-interfaces" type="button" role="tab" onclick="loadDeviceAdvancedInterfaces('${deviceId}')">
                        <i class="bi bi-router"></i> Interfacce Avanzate
                    </button>
                </li>
                ` : ''}
                ${isProxmox ? `
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="proxmox-tab" data-bs-toggle="tab" data-bs-target="#proxmox" type="button" role="tab" onclick="loadProxmoxInfo('${deviceId}')">
                        <i class="bi bi-server"></i> Proxmox
                    </button>
                </li>
                ` : ''}
            </ul>
            <div class="tab-content" id="deviceDetailTabContent">
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    ${detailsHtml}
        `;
        
        // Server Roles (Windows)
        const serverRoles = device.server_roles || cf.server_roles;
        if (serverRoles && serverRoles.length > 0) {
            modalContent += `
                <hr>
                <h6 class="text-muted mb-3">Ruoli Server (${serverRoles.length})</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${serverRoles.map(role => `<span class="badge bg-primary">${role}</span>`).join('')}
                </div>
            `;
        }

        // Important Services
        const importantServices = device.important_services || cf.important_services;
        if (importantServices && importantServices.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Servizi Importanti (${importantServices.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Nome</th><th>Descrizione</th><th>Stato</th><th>Avvio</th></tr></thead>
                        <tbody>
                            ${importantServices.map(svc => `
                                <tr>
                                    <td><code>${svc.name || svc}</code></td>
                                    <td><small>${svc.display_name || '-'}</small></td>
                                    <td><span class="badge bg-${svc.state === 'Running' ? 'success' : 'secondary'}">${svc.state || '-'}</span></td>
                                    <td><small>${svc.start_mode || '-'}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Network Adapters (WMI/SSH collected)
        const networkAdapters = device.network_adapters || cf.network_adapters;
        if (networkAdapters && networkAdapters.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Schede di Rete (${networkAdapters.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Nome</th><th>MAC</th><th>IP</th><th>Gateway</th><th>DNS</th></tr></thead>
                        <tbody>
                            ${networkAdapters.map(nic => `
                                <tr>
                                    <td><small>${nic.name || nic.description || '-'}</small></td>
                                    <td><code>${nic.mac || '-'}</code></td>
                                    <td><small>${Array.isArray(nic.ips) ? nic.ips.filter(ip => !ip.includes(':')).join(', ') : (nic.ips || '-')}</small></td>
                                    <td><small>${Array.isArray(nic.gateway) ? nic.gateway.join(', ') : (nic.gateway || '-')}</small></td>
                                    <td><small>${Array.isArray(nic.dns) ? nic.dns.join(', ') : (nic.dns || '-')}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Installed Software
        const installedSoftware = device.installed_software || cf.installed_software;
        if (installedSoftware && installedSoftware.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Software Installato (${installedSoftware.length})</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Nome</th><th>Versione</th><th>Produttore</th></tr></thead>
                        <tbody>
                            ${installedSoftware.map(sw => `
                                <tr>
                                    <td><small>${sw.name}</small></td>
                                    <td><small>${sw.version || '-'}</small></td>
                                    <td><small>${sw.vendor || '-'}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Local Users
        const localUsers = device.local_users || cf.local_users;
        if (localUsers && localUsers.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Utenti Locali (${localUsers.length})</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${localUsers.map(user => `
                        <span class="badge ${user.disabled ? 'bg-secondary' : 'bg-info'}">
                            ${user.name} ${user.disabled ? '(disabilitato)' : ''}
                        </span>
                    `).join('')}
                </div>
            `;
        }

        // Memory Modules
        const memoryModules = device.memory_modules || cf.memory_modules;
        if (memoryModules && memoryModules.length > 0) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Moduli RAM (${memoryModules.length})</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${memoryModules.map(mod => `
                        <span class="badge bg-secondary">
                            ${mod.size_gb || '?'} GB ${mod.speed_mhz ? '@ ' + mod.speed_mhz + ' MHz' : ''} 
                            ${mod.manufacturer ? '(' + mod.manufacturer + ')' : ''}
                        </span>
                    `).join('')}
                </div>
            `;
        }
        
        // Disks from custom_fields
        const cfDisks = cf.disks;
        if (cfDisks && cfDisks.length > 0 && (!device.disks || device.disks.length === 0)) {
            detailsHtml += `
                <hr>
                <h6 class="text-muted mb-3">Dischi (${cfDisks.length})</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Unit√†</th><th>FS</th><th>Etichetta</th><th>Dimensione</th><th>Libero</th></tr></thead>
                        <tbody>
                            ${cfDisks.map(disk => `
                                <tr>
                                    <td><code>${disk.device || disk.mount || '-'}</code></td>
                                    <td>${disk.filesystem || '-'}</td>
                                    <td>${disk.label || '-'}</td>
                                    <td>${disk.size_gb ? disk.size_gb + ' GB' : '-'}</td>
                                    <td>${disk.free_gb ? disk.free_gb + ' GB' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Extra Info from custom_fields
        if (Object.keys(cf).length > 0) {
            const hasExtraInfo = cf.domain_role || cf.is_server !== undefined || cf.virtualization || 
                                 cf.timezone || cf.docker_containers_running !== undefined || cf.uptime || cf.last_boot;
            if (hasExtraInfo) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3">Informazioni Aggiuntive</h6>
                    <div class="row">
                        ${cf.domain_role ? '<div class="col-md-4 mb-2"><strong>Ruolo Dominio:</strong> ' + cf.domain_role + '</div>' : ''}
                        ${cf.is_server !== undefined ? '<div class="col-md-4 mb-2"><strong>Server:</strong> ' + (cf.is_server ? 'S√¨' : 'No') + '</div>' : ''}
                        ${cf.is_domain_controller !== undefined ? '<div class="col-md-4 mb-2"><strong>DC:</strong> ' + (cf.is_domain_controller ? 'S√¨' : 'No') + '</div>' : ''}
                        ${cf.virtualization ? '<div class="col-md-4 mb-2"><strong>Virtualizzazione:</strong> ' + cf.virtualization + '</div>' : ''}
                        ${cf.timezone ? '<div class="col-md-4 mb-2"><strong>Timezone:</strong> ' + cf.timezone + '</div>' : ''}
                        ${cf.docker_containers_running !== undefined ? '<div class="col-md-4 mb-2"><strong>Container Docker:</strong> ' + cf.docker_containers_running + '</div>' : ''}
                        ${cf.lxc_containers !== undefined ? '<div class="col-md-4 mb-2"><strong>Container LXC:</strong> ' + cf.lxc_containers + '</div>' : ''}
                        ${cf.vms !== undefined ? '<div class="col-md-4 mb-2"><strong>VM:</strong> ' + cf.vms + '</div>' : ''}
                        ${cf.last_boot ? '<div class="col-md-4 mb-2"><strong>Ultimo Boot:</strong> ' + cf.last_boot + '</div>' : ''}
                        ${cf.uptime ? '<div class="col-md-4 mb-2"><strong>Uptime:</strong> ' + cf.uptime + '</div>' : ''}
                        ${cf.kernel ? '<div class="col-md-4 mb-2"><strong>Kernel:</strong> ' + cf.kernel + '</div>' : ''}
                        ${cf.bios_version ? '<div class="col-md-4 mb-2"><strong>BIOS:</strong> ' + cf.bios_version + '</div>' : ''}
                        ${cf.default_gateway ? '<div class="col-md-4 mb-2"><strong>Gateway:</strong> ' + cf.default_gateway + '</div>' : ''}
                        ${cf.dns_servers ? '<div class="col-md-4 mb-2"><strong>DNS:</strong> ' + cf.dns_servers.join(', ') + '</div>' : ''}
                        ${cf.load_average ? '<div class="col-md-4 mb-2"><strong>Load Avg:</strong> ' + cf.load_average + '</div>' : ''}
                        ${cf.packages_installed ? '<div class="col-md-4 mb-2"><strong>Pacchetti:</strong> ' + cf.packages_installed + '</div>' : ''}
                    </div>
                `;
            }
            
            // Linux: Servizi attivi
            if (cf.running_services && cf.running_services.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-gear-fill"></i> Servizi Attivi (${cf.running_services_count || cf.running_services.length})</h6>
                    <div class="mb-2">
                        ${cf.important_services ? '<strong>Servizi Importanti:</strong> ' + cf.important_services.map(s => '<span class="badge bg-primary me-1">' + s + '</span>').join('') : ''}
                    </div>
                    <details class="mb-2">
                        <summary class="text-muted" style="cursor: pointer;">Mostra tutti i servizi (${cf.running_services.length})</summary>
                        <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                            ${cf.running_services.map(s => '<span class="badge bg-secondary me-1 mb-1">' + s + '</span>').join('')}
                        </div>
                    </details>
                `;
            }
            
            // Linux: Cron Jobs
            if (cf.cron_jobs && cf.cron_jobs.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-clock-history"></i> Cron Jobs (${cf.cron_jobs_count || cf.cron_jobs.length})</h6>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Sorgente</th><th>Job</th></tr></thead>
                            <tbody>
                                ${cf.cron_jobs.map(cj => '<tr><td><small>' + cj.source + '</small></td><td><code style="font-size: 0.75em;">' + (cj.job || '-') + '</code></td></tr>').join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Linux: Network / IP Addresses
            if (cf.ip_addresses && cf.ip_addresses.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-diagram-3"></i> Indirizzi IP (${cf.ip_addresses.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Interfaccia</th><th>Indirizzo</th><th>Prefix</th></tr></thead>
                            <tbody>
                                ${cf.ip_addresses.filter(ip => !ip.address.startsWith('127.')).map(ip => '<tr><td>' + ip.interface + '</td><td><code>' + ip.address + '</code></td><td>' + (ip.prefix || '-') + '</td></tr>').join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Linux: Routes
            if (cf.routes && cf.routes.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-signpost-split"></i> Routing Table (${cf.routes.length})</h6>
                    <div style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8em;">
                        ${cf.routes.map(r => '<div>' + r + '</div>').join('')}
                    </div>
                `;
            }
            
            // Linux: Listening Ports
            if (cf.listening_ports && cf.listening_ports.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-plug"></i> Porte in Ascolto (${cf.listening_ports.length})</h6>
                    <div>
                        ${cf.listening_ports.slice(0, 30).map(p => '<span class="badge bg-info me-1 mb-1">' + p + '</span>').join('')}
                        ${cf.listening_ports.length > 30 ? '<span class="text-muted">... e altri ' + (cf.listening_ports.length - 30) + '</span>' : ''}
                    </div>
                `;
            }
            
            // Linux: Block Devices
            if (cf.block_devices && cf.block_devices.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-device-hdd"></i> Block Devices (${cf.block_devices.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Nome</th><th>Dimensione</th><th>Tipo</th><th>Modello</th></tr></thead>
                            <tbody>
                                ${cf.block_devices.map(bd => '<tr><td>' + bd.name + '</td><td>' + bd.size + '</td><td>' + bd.type + '</td><td>' + (bd.model || '-') + '</td></tr>').join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Linux: Hardware Inventory
            if (cf.hardware_inventory) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-cpu"></i> Hardware Inventory</h6>
                    <pre style="max-height: 200px; overflow-y: auto; font-size: 0.75em; background: #f8f9fa; padding: 10px; border-radius: 4px;">${cf.hardware_inventory}</pre>
                `;
            }
            
            // MikroTik: Routing Table
            if (cf.routing_table && cf.routing_table.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-signpost-split"></i> Routing Table MikroTik (${cf.routing_count || cf.routing_table.length})</h6>
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Destinazione</th><th>Gateway</th><th>Distanza</th><th>Interfaccia</th></tr></thead>
                            <tbody>
                                ${cf.routing_table.map(r => '<tr><td><code>' + (r.dst || r['dst-address'] || '-') + '</code></td><td>' + (r.gateway || '-') + '</td><td>' + (r.distance || '-') + '</td><td>' + (r['pref-src'] || r.interface || '-') + '</td></tr>').join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // MikroTik: ARP Table
            if (cf.arp_table && cf.arp_table.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-table"></i> ARP Table MikroTik (${cf.arp_count || cf.arp_table.length})</h6>
                    <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>IP</th><th>MAC</th><th>Interfaccia</th><th>Stato</th></tr></thead>
                            <tbody>
                                ${cf.arp_table.slice(0, 100).map(a => '<tr><td><code>' + (a.address || '-') + '</code></td><td><small>' + (a['mac-address'] || '-') + '</small></td><td>' + (a.interface || '-') + '</td><td><span class="badge bg-' + (a.status === 'reachable' ? 'success' : 'secondary') + '">' + (a.status || '-') + '</span></td></tr>').join('')}
                            </tbody>
                        </table>
                        ${cf.arp_table.length > 100 ? '<div class="text-muted text-center">Mostrati 100 di ' + cf.arp_table.length + ' entries</div>' : ''}
                    </div>
                `;
            }
            
            // MikroTik/Network: Neighbors (LLDP/CDP/MNDP)
            if (cf.neighbors && cf.neighbors.length > 0) {
                detailsHtml += `
                    <hr>
                    <h6 class="text-muted mb-3"><i class="bi bi-diagram-3-fill"></i> Network Neighbors - LLDP/CDP/MNDP (${cf.neighbors_count || cf.neighbors.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Interfaccia Locale</th>
                                    <th>Dispositivo Remoto</th>
                                    <th>IP Remoto</th>
                                    <th>MAC</th>
                                    <th>Piattaforma</th>
                                    <th>Scoperto via</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cf.neighbors.map(n => `
                                    <tr>
                                        <td><code>${n.local_interface || '-'}</code></td>
                                        <td>
                                            <strong>${n.remote_device_name || n.identity || '-'}</strong>
                                            ${n.board ? '<br><small class="text-muted">' + n.board + '</small>' : ''}
                                        </td>
                                        <td><code>${n.remote_ip || n.address || '-'}</code></td>
                                        <td><small>${n.remote_mac || n['mac-address'] || '-'}</small></td>
                                        <td>
                                            ${n.platform || '-'}
                                            ${n.version ? '<br><small class="text-muted">' + n.version.substring(0, 30) + '</small>' : ''}
                                        </td>
                                        <td><span class="badge bg-info">${n.discovered_by || '-'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // Note e descrizione
        if (device.description || device.notes) {
            modalContent += `
                <hr>
                <h6 class="text-muted mb-3">Note</h6>
                ${device.description ? '<p><strong>Descrizione:</strong> ' + device.description + '</p>' : ''}
                ${device.notes ? '<p><strong>Note:</strong> ' + device.notes + '</p>' : ''}
            `;
        }
        
        modalContent += `
                </div>
                ${device.network_interfaces && device.network_interfaces.length > 0 ? `
                <div class="tab-pane fade" id="interfaces" role="tabpanel">
                    <h6 class="text-muted mb-3">Interfacce di Rete (${device.network_interfaces.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>MAC</th>
                                    <th>IP</th>
                                    <th>Velocit√†</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${device.network_interfaces.map(nic => {
                                    const ips = nic.ip_addresses ? (typeof nic.ip_addresses === 'string' ? JSON.parse(nic.ip_addresses) : nic.ip_addresses).map(ip => ip.ip || ip).join(', ') : '-';
                                    return `
                                        <tr>
                                            <td><code>${nic.name}</code></td>
                                            <td><small>${nic.mac_address || '-'}</small></td>
                                            <td><small>${ips}</small></td>
                                            <td>${nic.speed_mbps ? nic.speed_mbps + ' Mbps' : '-'}</td>
                                            <td><span class="badge bg-${nic.admin_status === 'up' ? 'success' : 'secondary'}">${nic.admin_status || '-'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                ${device.disks && device.disks.length > 0 ? `
                <div class="tab-pane fade" id="disks" role="tabpanel">
                    <h6 class="text-muted mb-3">Dischi (${device.disks.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Mount Point</th>
                                    <th>Filesystem</th>
                                    <th>Dimensione</th>
                                    <th>Utilizzato</th>
                                    <th>Uso %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${device.disks.map(disk => {
                                    const usedPercent = disk.percent_used || (disk.size_gb && disk.used_gb ? Math.round((disk.used_gb / disk.size_gb) * 100) : 0);
                                    const progressColor = usedPercent > 90 ? 'danger' : usedPercent > 75 ? 'warning' : 'success';
                                    return `
                                        <tr>
                                            <td><code>${disk.name}</code></td>
                                            <td>${disk.mount_point || '-'}</td>
                                            <td>${disk.filesystem || '-'}</td>
                                            <td>${disk.size_gb ? disk.size_gb.toFixed(1) + ' GB' : '-'}</td>
                                            <td>${disk.used_gb ? disk.used_gb.toFixed(1) + ' GB' : '-'}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-${progressColor}" style="width: ${usedPercent}%">${usedPercent}%</div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                ${isNetworkDevice ? `
                <div class="tab-pane fade" id="neighbors" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">Neighbor Discovery</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="loadDeviceNeighbors('${deviceId}')">
                                <i class="bi bi-arrow-clockwise"></i> Aggiorna
                            </button>
                        </div>
                    </div>
                    <ul class="nav nav-pills mb-3" id="neighborTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="lldp-tab" data-bs-toggle="pill" data-bs-target="#lldp-neighbors" type="button" role="tab" onclick="loadLLDPNeighbors('${deviceId}')">
                                LLDP Neighbors
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cdp-tab" data-bs-toggle="pill" data-bs-target="#cdp-neighbors" type="button" role="tab" onclick="loadCDPNeighbors('${deviceId}')">
                                CDP Neighbors
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="neighborTabContent">
                        <div class="tab-pane fade show active" id="lldp-neighbors" role="tabpanel">
                            <div id="lldpNeighborsContent" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm me-2"></div>
                                Caricamento LLDP neighbors...
                            </div>
                        </div>
                        <div class="tab-pane fade" id="cdp-neighbors" role="tabpanel">
                            <div id="cdpNeighborsContent" class="text-center py-4 text-muted">
                                Clicca su "CDP Neighbors" per caricare i dati
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="advanced-interfaces" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">Interfacce Avanzate</h6>
                    </div>
                    <div id="advancedInterfacesContent" class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Caricamento interfacce avanzate...
                    </div>
                </div>
                ` : ''}
                ${isProxmox ? `
                <div class="tab-pane fade" id="proxmox" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">Informazioni Proxmox</h6>
                    </div>
                    <div id="proxmoxContent" class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Caricamento informazioni Proxmox...
                    </div>
                </div>
                ` : ''}
            </div>
        `;

        // Mostra modal
        showModal('Dettagli Dispositivo: ' + device.name, modalContent, 'xl');

    } catch (e) {
        alert('Errore caricamento dettagli: ' + e.message);
    }
}

function showModal(title, content, size = 'md') {
    // Crea o riusa modal esistente
    let modal = document.getElementById('dynamicModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'dynamicModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-${size} modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Aggiorna contenuto
    modal.querySelector('.modal-title').textContent = title;
    modal.querySelector('.modal-body').innerHTML = content;
    modal.querySelector('.modal-dialog').className = `modal-dialog modal-${size} modal-dialog-scrollable`;

    // Mostra modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// ==========================================
// FUNZIONI BACKUP E GESTIONE MIKROTIK/HP-ARUBA
// ==========================================

async function backupMikroTikDevice(deviceId, deviceIp) {
    if (!confirm(`Eseguire backup configurazione MikroTik ${deviceIp}?`)) return;
    
    try {
        // Recupera credenziali del device
        const deviceResponse = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await deviceResponse.json();
        
        if (!device.credential_id) {
            alert('‚ö†Ô∏è Nessuna credenziale associata al dispositivo.\n\nAssocia una credenziale MikroTik prima di eseguire il backup.');
            return;
        }
        
        // Esegui backup tramite device-backup service
        const response = await fetch('/api/v1/device-backup/device', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                device_ip: deviceIp,
                customer_id: customerId,
                device_type: 'mikrotik',
                backup_type: 'both',  // export + binary
                credential_id: device.credential_id  // Usa credenziali associate al device
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Backup completato!\n\nFile: ${result.file_path || 'N/A'}\nBackup ID: ${result.backup_id || 'N/A'}`);
        } else {
            alert(`‚ùå Errore backup: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function manageMikroTikDevice(deviceId, deviceIp) {
    try {
        // Recupera device e credenziali
        const deviceResponse = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await deviceResponse.json();
        
        if (!device.credential_id) {
            alert('‚ö†Ô∏è Nessuna credenziale associata al dispositivo.\n\nAssocia una credenziale MikroTik per gestire il router.');
            return;
        }
        
        // Cerca agent MikroTik esistente per questo IP
        const agentsResponse = await fetch(`/api/v1/customers/${customerId}/agents`);
        const agentsData = await agentsResponse.json();
        const agents = agentsData.agents || [];
        
        // Cerca agent MikroTik con stesso IP
        const mikrotikAgent = agents.find(a => {
            const agentType = a.agent_type || 'mikrotik';
            return agentType === 'mikrotik' && a.address === deviceIp;
        });
        
        if (mikrotikAgent) {
            // Apri pagina gestione MikroTik con agent esistente
            window.location.href = `/customers/${customerId}/mikrotik/${mikrotikAgent.id}`;
        } else {
            // Nessun agent trovato - usa credenziali direttamente per operazioni base
            try {
                const infoResponse = await fetch(`/api/v1/mikrotik/credentials/${device.credential_id}/system-info?device_ip=${encodeURIComponent(deviceIp)}`);
                
                if (!infoResponse.ok) {
                    const errorText = await infoResponse.text();
                    let errorMsg = `Errore HTTP ${infoResponse.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.detail || errorJson.error || errorMsg;
                    } catch {
                        errorMsg = errorText || errorMsg;
                    }
                    alert(`‚ùå Errore connessione MikroTik:\n\n${errorMsg}\n\nVerifica:\n- Le credenziali associate al dispositivo\n- La connettivit√† di rete\n- Che il router sia raggiungibile`);
                    return;
                }
                
                const infoResult = await infoResponse.json();
                
                if (infoResult.success !== false) {
                    let info = `üì° Router MikroTik: ${deviceIp}\n\n`;
                    info += `Identity: ${infoResult.identity || 'N/A'}\n`;
                    info += `RouterOS: ${infoResult.version || 'N/A'}\n`;
                    info += `Board: ${infoResult.board_name || infoResult.board || 'N/A'}\n`;
                    info += `CPU Load: ${infoResult.cpu_load || 0}%\n`;
                    info += `Memory: ${infoResult.memory_free_mb || 0}MB / ${infoResult.memory_total_mb || 0}MB\n\n`;
                    info += `‚ö†Ô∏è Nessun Agent MikroTik configurato.\n\n`;
                    info += `Per gestione completa, crea un Agent nella sezione "Sonde".\n\n`;
                    info += `Vuoi creare un Agent MikroTik ora?`;
                    
                    if (confirm(info)) {
                        // Redirect alla pagina agenti con suggerimento
                        window.location.href = `/customers/${customerId}#agents`;
                        setTimeout(() => {
                            alert(`Per creare l'agent:\n1. Vai alla sezione "Sonde"\n2. Clicca "Aggiungi Sonda"\n3. Tipo: MikroTik\n4. IP: ${deviceIp}\n5. Credenziali: ${device.credential_id}`);
                        }, 500);
                    }
                } else {
                    alert(`‚ùå Errore connessione: ${infoResult.error || 'Errore sconosciuto'}\n\nVerifica le credenziali associate al dispositivo.`);
                }
            } catch (e) {
                console.error('MikroTik management error:', e);
                alert(`‚ùå Errore gestione MikroTik ${deviceIp}:\n\n${e.message}\n\nPer gestire questo router:\n1. Vai alla sezione "Sonde"\n2. Crea un nuovo Agent MikroTik\n3. Configura IP: ${deviceIp}\n4. Seleziona credenziali: ${device.credential_id || 'da configurare'}`);
            }
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function backupHPArubaDevice(deviceId, deviceIp) {
    if (!confirm(`Eseguire backup configurazione HP/Aruba ${deviceIp}?`)) return;
    
    try {
        // Recupera credenziali del device
        const deviceResponse = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await deviceResponse.json();
        
        if (!device.credential_id) {
            alert('‚ö†Ô∏è Nessuna credenziale associata al dispositivo.\n\nAssocia una credenziale SSH prima di eseguire il backup.');
            return;
        }
        
        // Esegui backup tramite device-backup service
        const response = await fetch('/api/v1/device-backup/device', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                device_ip: deviceIp,
                customer_id: customerId,
                device_type: 'hp_aruba',
                backup_type: 'export'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Backup completato!\n\nFile: ${result.file_path || result.export_file_path || 'N/A'}\nBackup ID: ${result.backup_id || 'N/A'}`);
        } else {
            alert(`‚ùå Errore backup: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function manageHPArubaDevice(deviceId, deviceIp) {
    try {
        // Recupera credenziali del device
        const deviceResponse = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await deviceResponse.json();
        
        if (!device.credential_id) {
            alert('‚ö†Ô∏è Nessuna credenziale associata al dispositivo.\n\nAssocia una credenziale SSH per gestire lo switch.');
            return;
        }
        
        // Mostra info switch HP/Aruba
        const infoResponse = await fetch(`/api/v1/hp-aruba/credentials/${device.credential_id}/switch-info`);
        const infoResult = await infoResponse.json();
        
        if (infoResult.success) {
            let info = `üì° Switch HP/Aruba: ${deviceIp}\n\n`;
            info += `Sistema: ${infoResult.system_info?.system_name || 'N/A'}\n`;
            info += `Modello: ${infoResult.system_info?.model || 'N/A'}\n`;
            info += `Firmware: ${infoResult.system_info?.firmware || 'N/A'}\n`;
            info += `Interfacce: ${Object.keys(infoResult.interfaces || {}).length}\n`;
            info += `VLAN: ${Object.keys(infoResult.vlans || {}).length}\n`;
            info += `LLDP Neighbors: ${Object.keys(infoResult.lldp || {}).length}\n`;
            
            if (confirm(info + '\n\nVuoi vedere i dettagli completi?')) {
                // Apri modal con dettagli completi
                showModal('Switch HP/Aruba - ' + deviceIp, `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informazioni Sistema</h6>
                            <pre class="bg-light p-2 small">${JSON.stringify(infoResult.system_info || {}, null, 2)}</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Interfacce (${Object.keys(infoResult.interfaces || {}).length})</h6>
                            <pre class="bg-light p-2 small" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(infoResult.interfaces || {}, null, 2)}</pre>
                        </div>
                    </div>
                `, 'xl');
            }
        } else {
            alert(`‚ùå Errore recupero info: ${infoResult.error || 'Errore sconosciuto'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function backupProxmoxDevice(deviceId, deviceIp) {
    if (!confirm(`Eseguire backup configurazione Proxmox ${deviceIp}?\n\nVerranno salvate le configurazioni di:\n- /etc/pve/ (cluster, VM/CT, storage)\n- /etc/vzdump.conf\n- /etc/network/interfaces\n- E altre configurazioni critiche`)) return;
    
    try {
        // Recupera credenziali del device
        const deviceResponse = await fetch(`/api/v1/inventory/devices/${deviceId}`);
        const device = await deviceResponse.json();
        
        if (!device.credential_id) {
            alert('‚ö†Ô∏è Nessuna credenziale associata al dispositivo.\n\nAssocia una credenziale SSH prima di eseguire il backup.');
            return;
        }
        
        const response = await fetch('/api/v1/device-backup/device', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                device_ip: deviceIp,
                customer_id: customerId,
                device_type: 'proxmox',
                backup_type: 'config',
                credential_id: device.credential_id
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const fileSize = result.device_info?.file_size ? (result.device_info.file_size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A';
            alert(`‚úÖ Backup Proxmox completato!\n\nFile: ${result.file_path || 'N/A'}\nDimensione: ${fileSize}\nBackup ID: ${result.backup_id || 'N/A'}`);
        } else {
            alert(`‚ùå Errore backup: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// FUNZIONI PER INFORMAZIONI AVANZATE DEVICE
// ==========================================

async function loadDeviceNeighbors(deviceId) {
    await Promise.all([
        loadLLDPNeighbors(deviceId),
        loadCDPNeighbors(deviceId)
    ]);
}

async function loadLLDPNeighbors(deviceId) {
    const content = document.getElementById('lldpNeighborsContent');
    if (!content) return;
    
    content.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Caricamento...';
    
    try {
        const response = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/lldp-neighbors`);
        const data = await response.json();
        
        if (data.success && data.neighbors && data.neighbors.length > 0) {
            content.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Interfaccia Locale</th>
                                <th>Dispositivo Remoto</th>
                                <th>Porta Remota</th>
                                <th>MAC Remoto</th>
                                <th>IP Remoto</th>
                                <th>Chassis ID</th>
                                <th>Ultimo Visto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.neighbors.map(n => `
                                <tr>
                                    <td><code>${n.local_interface}</code></td>
                                    <td>
                                        <strong>${n.remote_device_name || '-'}</strong>
                                        ${n.remote_device_description ? '<br><small class="text-muted">' + n.remote_device_description + '</small>' : ''}
                                    </td>
                                    <td>${n.remote_port || '-'}</td>
                                    <td><code class="small">${n.remote_mac || '-'}</code></td>
                                    <td><code class="small">${n.remote_ip || '-'}</code></td>
                                    <td><code class="small">${n.chassis_id || '-'}</code></td>
                                    <td><small>${n.last_seen ? new Date(n.last_seen).toLocaleString('it-IT') : '-'}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-info-circle"></i> Trovati ${data.count || data.neighbors.length} neighbor LLDP
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Nessun neighbor LLDP trovato.
                    <br><small>I dati vengono raccolti automaticamente durante l'autodetect.</small>
                </div>
            `;
        }
    } catch (e) {
        content.innerHTML = `<div class="alert alert-danger">Errore: ${e.message}</div>`;
    }
}

async function loadCDPNeighbors(deviceId) {
    const content = document.getElementById('cdpNeighborsContent');
    if (!content) return;
    
    content.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Caricamento...';
    
    try {
        const response = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/cdp-neighbors`);
        const data = await response.json();
        
        if (data.success && data.neighbors && data.neighbors.length > 0) {
            content.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Interfaccia Locale</th>
                                <th>Device ID</th>
                                <th>Nome Dispositivo</th>
                                <th>Porta Remota</th>
                                <th>IP Remoto</th>
                                <th>Versione</th>
                                <th>Platform</th>
                                <th>Ultimo Visto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.neighbors.map(n => `
                                <tr>
                                    <td><code>${n.local_interface}</code></td>
                                    <td><code class="small">${n.remote_device_id || '-'}</code></td>
                                    <td><strong>${n.remote_device_name || '-'}</strong></td>
                                    <td>${n.remote_port || '-'}</td>
                                    <td><code class="small">${n.remote_ip || '-'}</code></td>
                                    <td><small>${n.remote_version || '-'}</small></td>
                                    <td><small>${n.platform || '-'}</small></td>
                                    <td><small>${n.last_seen ? new Date(n.last_seen).toLocaleString('it-IT') : '-'}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-info-circle"></i> Trovati ${data.count || data.neighbors.length} neighbor CDP
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Nessun neighbor CDP trovato.
                    <br><small>CDP √® disponibile solo su dispositivi Cisco.</small>
                </div>
            `;
        }
    } catch (e) {
        content.innerHTML = `<div class="alert alert-danger">Errore: ${e.message}</div>`;
    }
}

async function loadDeviceAdvancedInterfaces(deviceId) {
    const content = document.getElementById('advancedInterfacesContent');
    if (!content) return;
    
    content.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Caricamento...';
    
    try {
        const response = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/interfaces`);
        const data = await response.json();
        
        if (data.success && data.interfaces && data.interfaces.length > 0) {
            content.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>MAC</th>
                                <th>Velocit√†</th>
                                <th>Stato</th>
                                <th>LLDP</th>
                                <th>CDP</th>
                                <th>PoE</th>
                                <th>VLAN Native</th>
                                <th>VLAN Trunk</th>
                                <th>STP</th>
                                <th>LACP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.interfaces.map(iface => {
                                const vlanTrunk = iface.vlan_trunk_allowed ? 
                                    (typeof iface.vlan_trunk_allowed === 'string' ? JSON.parse(iface.vlan_trunk_allowed) : iface.vlan_trunk_allowed) : [];
                                const vlanTrunkDisplay = Array.isArray(vlanTrunk) && vlanTrunk.length > 0 ? 
                                    vlanTrunk.map(v => `<span class="badge bg-secondary">${v}</span>`).join(' ') : '-';
                                
                                return `
                                    <tr>
                                        <td><code>${iface.name}</code></td>
                                        <td><small>${iface.mac_address || '-'}</small></td>
                                        <td>${iface.speed_mbps ? iface.speed_mbps + ' Mbps' : '-'}</td>
                                        <td>
                                            <span class="badge bg-${iface.oper_status === 'up' ? 'success' : 'secondary'}">${iface.oper_status || '-'}</span>
                                        </td>
                                        <td>${iface.lldp_enabled !== null ? (iface.lldp_enabled ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>') : '-'}</td>
                                        <td>${iface.cdp_enabled !== null ? (iface.cdp_enabled ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>') : '-'}</td>
                                        <td>
                                            ${iface.poe_enabled ? 
                                                `<i class="bi bi-lightning-charge text-warning"></i> ${iface.poe_power_watts ? iface.poe_power_watts + 'W' : ''}` : 
                                                '<i class="bi bi-x-circle text-muted"></i>'}
                                        </td>
                                        <td>${iface.vlan_native || '-'}</td>
                                        <td>${vlanTrunkDisplay}</td>
                                        <td>${iface.stp_state ? `<span class="badge bg-info">${iface.stp_state}</span>` : '-'}</td>
                                        <td>${iface.lacp_enabled !== null ? (iface.lacp_enabled ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>') : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-info-circle"></i> Trovate ${data.count || data.interfaces.length} interfacce con dettagli avanzati
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Nessuna interfaccia con dettagli avanzati trovata.
                    <br><small>I dati vengono raccolti automaticamente durante l'autodetect.</small>
                </div>
            `;
        }
    } catch (e) {
        content.innerHTML = `<div class="alert alert-danger">Errore: ${e.message}</div>`;
    }
}

// Funzione helper per formattare uptime
function formatUptime(seconds) {
    if (!seconds) return '-';
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const parts = [];
    if (days > 0) parts.push(`${days}d`);
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    return parts.length > 0 ? parts.join(' ') : '0m';
}

// Funzione helper per formattare bytes
function formatBytes(bytes) {
    if (!bytes) return '-';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    return `${size.toFixed(2)} ${units[unitIndex]}`;
}

async function loadProxmoxInfo(deviceId) {
    const content = document.getElementById('proxmoxContent');
    if (!content) return;
    
    content.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Caricamento informazioni Proxmox...';
    
    try {
        // Carica info host
        const hostResponse = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/proxmox/host`);
        const hostData = await hostResponse.json();
        
        // Carica VM
        const vmsResponse = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/proxmox/vms`);
        const vmsData = await vmsResponse.json();
        
        // Carica storage
        const storageResponse = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/proxmox/storage`);
        const storageData = await storageResponse.json();
        
        let proxmoxHtml = '';
        
        // Host Info
        if (hostData.success && hostData.host_info) {
            const hi = hostData.host_info;
            proxmoxHtml += `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-server"></i> Informazioni Host</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th width="40%">Node Name:</th><td><strong>${hi.node_name}</strong></td></tr>
                                    ${hi.cluster_name ? `<tr><th>Cluster:</th><td>${hi.cluster_name}</td></tr>` : ''}
                                    <tr><th>Proxmox Version:</th><td>${hi.proxmox_version || '-'}</td></tr>
                                    ${hi.manager_version ? `<tr><th>Manager Version:</th><td>${hi.manager_version}</td></tr>` : ''}
                                    <tr><th>Kernel:</th><td>${hi.kernel_version || '-'}</td></tr>
                                    ${hi.boot_mode ? `<tr><th>Boot Mode:</th><td><span class="badge bg-info">${hi.boot_mode}</span></td></tr>` : ''}
                                    <tr><th>CPU Model:</th><td>${hi.cpu_model || '-'}</td></tr>
                                    <tr><th>CPU Cores:</th><td>${hi.cpu_total_cores || hi.cpu_cores || '-'} (${hi.cpu_sockets || '-'} sockets, ${hi.cpu_threads || '-'} threads/core)</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th width="40%">Memory:</th><td>
                                        ${hi.memory_total_gb ? hi.memory_total_gb.toFixed(1) + ' GB' : '-'}
                                        ${hi.memory_usage_percent ? ` (${hi.memory_usage_percent.toFixed(1)}% utilizzato)` : ''}
                                        ${hi.memory_used_gb ? ` - Usato: ${hi.memory_used_gb.toFixed(1)} GB` : ''}
                                        ${hi.memory_free_gb ? ` - Libero: ${hi.memory_free_gb.toFixed(1)} GB` : ''}
                                    </td></tr>
                                    ${hi.swap_total_gb ? `<tr><th>Swap:</th><td>
                                        ${hi.swap_total_gb.toFixed(1)} GB totale
                                        ${hi.swap_used_gb ? ` - Usato: ${hi.swap_used_gb.toFixed(1)} GB` : ''}
                                        ${hi.swap_usage_percent ? ` (${hi.swap_usage_percent.toFixed(1)}%)` : ''}
                                    </td></tr>` : ''}
                                    ${hi.rootfs_total_gb ? `<tr><th>Root FS:</th><td>
                                        ${hi.rootfs_total_gb.toFixed(1)} GB totale
                                        ${hi.rootfs_used_gb ? ` - Usato: ${hi.rootfs_used_gb.toFixed(1)} GB` : ''}
                                        ${hi.rootfs_usage_percent ? ` (${hi.rootfs_usage_percent.toFixed(1)}%)` : ''}
                                    </td></tr>` : ''}
                                    ${hi.ksm_sharing_gb ? `<tr><th>KSM Sharing:</th><td>${hi.ksm_sharing_gb.toFixed(2)} GB</td></tr>` : ''}
                                    <tr><th>CPU Usage:</th><td>
                                        ${hi.cpu_usage_percent !== null ? `
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" style="width: ${hi.cpu_usage_percent}%">${hi.cpu_usage_percent.toFixed(1)}%</div>
                                            </div>
                                        ` : '-'}
                                    </td></tr>
                                    ${hi.io_delay_percent !== null ? `<tr><th>IO Delay:</th><td>${hi.io_delay_percent.toFixed(2)}%</td></tr>` : ''}
                                    <tr><th>Uptime:</th><td>${hi.uptime_human || '-'}</td></tr>
                                    <tr><th>Load Average:</th><td>
                                        ${hi.load_average_1m !== null ? `${hi.load_average_1m.toFixed(2)}, ${hi.load_average_5m.toFixed(2)}, ${hi.load_average_15m.toFixed(2)}` : '-'}
                                    </td></tr>
                                    <tr><th>License:</th><td>
                                        ${hi.license_status ? `<span class="badge bg-${hi.license_status === 'active' ? 'success' : 'warning'}">${hi.license_status}</span>` : '-'}
                                        ${hi.license_level ? ` (${hi.license_level})` : ''}
                                        ${hi.subscription_type ? `<br><small>Type: ${hi.subscription_type}</small>` : ''}
                                        ${hi.subscription_server_id ? `<br><small>Server ID: ${hi.subscription_server_id}</small>` : ''}
                                        ${hi.subscription_sockets ? `<br><small>Sockets: ${hi.subscription_sockets}</small>` : ''}
                                        ${hi.subscription_next_due ? `<br><small>Next Due: ${hi.subscription_next_due}</small>` : ''}
                                    </td></tr>
                                    ${hi.repository_status ? `<tr><th>Repositories:</th><td><small>${hi.repository_status}</small></td></tr>` : ''}
                                </table>
                            </div>
                        </div>
                        
                        ${(hi.temperature_summary && hi.temperature_summary.length > 0) || hi.temperature_highest_c ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="bi bi-thermometer-half"></i> Temperature</h6>
                                ${hi.temperature_highest_c ? `<p><strong>Massima:</strong> ${hi.temperature_highest_c.toFixed(1)}¬∞C</p>` : ''}
                                ${hi.temperature_summary && hi.temperature_summary.length > 0 ? `
                                    <ul class="mb-0">
                                        ${hi.temperature_summary.slice(0, 10).map(t => `<li><small>${t}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hi.bios_vendor || hi.bios_version || hi.system_manufacturer || hi.system_product ? `
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6><i class="bi bi-motherboard"></i> BIOS & System</h6>
                                <table class="table table-sm mb-0">
                                    ${hi.bios_vendor ? `<tr><th width="40%">BIOS Vendor:</th><td>${hi.bios_vendor}</td></tr>` : ''}
                                    ${hi.bios_version ? `<tr><th>BIOS Version:</th><td>${hi.bios_version}</td></tr>` : ''}
                                    ${hi.bios_release_date ? `<tr><th>BIOS Date:</th><td>${hi.bios_release_date}</td></tr>` : ''}
                                    ${hi.system_manufacturer ? `<tr><th>Manufacturer:</th><td>${hi.system_manufacturer}</td></tr>` : ''}
                                    ${hi.system_product ? `<tr><th>Product:</th><td>${hi.system_product}</td></tr>` : ''}
                                    ${hi.system_serial ? `<tr><th>Serial:</th><td>${hi.system_serial}</td></tr>` : ''}
                                    ${hi.board_vendor ? `<tr><th>Board Vendor:</th><td>${hi.board_vendor}</td></tr>` : ''}
                                    ${hi.board_name ? `<tr><th>Board Name:</th><td>${hi.board_name}</td></tr>` : ''}
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hi.boot_devices && hi.boot_devices.length > 0 ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="bi bi-hdd"></i> Boot Devices</h6>
                                <ul class="mb-0">
                                    ${hi.boot_devices.slice(0, 10).map(d => `<li><small>${d}</small></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hi.hardware_product || (hi.hardware_system && hi.hardware_system.length > 0) ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="bi bi-cpu"></i> Hardware Info</h6>
                                ${hi.hardware_product ? `<p><strong>Product:</strong> ${hi.hardware_product}</p>` : ''}
                                ${hi.hardware_system && hi.hardware_system.length > 0 ? `
                                    <p><strong>System:</strong></p>
                                    <ul class="mb-2">
                                        ${hi.hardware_system.slice(0, 5).map(h => `<li><small>${h}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${hi.hardware_processor && hi.hardware_processor.length > 0 ? `
                                    <p><strong>Processor:</strong></p>
                                    <ul class="mb-2">
                                        ${hi.hardware_processor.slice(0, 5).map(h => `<li><small>${h}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${hi.hardware_memory && hi.hardware_memory.length > 0 ? `
                                    <p><strong>Memory:</strong></p>
                                    <ul class="mb-2">
                                        ${hi.hardware_memory.slice(0, 5).map(h => `<li><small>${h}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${hi.hardware_disk && hi.hardware_disk.length > 0 ? `
                                    <p><strong>Disks:</strong></p>
                                    <ul class="mb-2">
                                        ${hi.hardware_disk.slice(0, 5).map(h => `<li><small>${h}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${hi.hardware_network && hi.hardware_network.length > 0 ? `
                                    <p><strong>Network:</strong></p>
                                    <ul class="mb-2">
                                        ${hi.hardware_network.slice(0, 5).map(h => `<li><small>${h}</small></li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hi.pci_devices && hi.pci_devices.length > 0 ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="bi bi-pci-card"></i> PCI Devices</h6>
                                <ul class="mb-0">
                                    ${hi.pci_devices.slice(0, 10).map(d => `<li><small>${d}</small></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hi.usb_devices && hi.usb_devices.length > 0 ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="bi bi-usb"></i> USB Devices</h6>
                                <ul class="mb-0">
                                    ${hi.usb_devices.slice(0, 10).map(d => `<li><small>${d}</small></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            proxmoxHtml += `
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Informazioni host Proxmox non disponibili.
                    <br><small>I dati vengono raccolti automaticamente durante l'autodetect.</small>
                </div>
            `;
        }
        
        // VM List
        if (vmsData.success && vmsData.vms && vmsData.vms.length > 0) {
            const vmsWithIp = vmsData.vms.filter(vm => vm.ip_addresses && vm.ip_addresses.trim() !== '').length;
            proxmoxHtml += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-box"></i> Virtual Machines (${vmsData.count || vmsData.vms.length})</h6>
                        ${vmsWithIp > 0 ? `
                            <button class="btn btn-sm btn-primary" onclick="createVmInventoryDevices('${deviceId}')" title="Crea dispositivi inventario per VM con IP">
                                <i class="bi bi-plus-circle"></i> Crea Dispositivi Inventario (${vmsWithIp} VM con IP)
                            </button>
                        ` : ''}
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>VM ID</th>
                                        <th>Nome</th>
                                        <th>Type</th>
                                        <th>Stato</th>
                                        <th>CPU</th>
                                        <th>RAM</th>
                                        <th>Disco</th>
                                        <th>IP Addresses</th>
                                        <th>OS Type</th>
                                        <th>Agent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vmsData.vms.map((vm, idx) => {
                                        const cpuInfo = vm.cpu_total ? `${vm.cpu_total} cores` : (vm.cpu_cores ? `${vm.cpu_cores} cores` : '-');
                                        const cpuSockets = vm.cpu_sockets ? ` (${vm.cpu_sockets} sockets)` : '';
                                        const vmDetailsId = `vm-details-${idx}`;
                                        
                                        // Dettagli dischi
                                        let disksHtml = '';
                                        if (vm.disks_details && Array.isArray(vm.disks_details) && vm.disks_details.length > 0) {
                                            disksHtml = '<div class="mt-2"><strong>Dischi:</strong><ul class="mb-0">';
                                            vm.disks_details.forEach(disk => {
                                                disksHtml += `<li>${disk.id || 'N/A'}: ${disk.storage || 'N/A'}${disk.size ? ` (${disk.size})` : ''}${disk.cache ? ` [cache: ${disk.cache}]` : ''}</li>`;
                                            });
                                            disksHtml += '</ul></div>';
                                        }
                                        
                                        // Dettagli network
                                        let networksHtml = '';
                                        if (vm.network_interfaces && Array.isArray(vm.network_interfaces) && vm.network_interfaces.length > 0) {
                                            networksHtml = '<div class="mt-2"><strong>Network:</strong><ul class="mb-0">';
                                            vm.network_interfaces.forEach(net => {
                                                networksHtml += `<li>${net.id || 'N/A'}: ${net.model || 'N/A'}${net.mac ? ` (${net.mac})` : ''}${net.bridge ? ` ‚Üí ${net.bridge}` : ''}${net.vlan ? ` VLAN ${net.vlan}` : ''}</li>`;
                                            });
                                            networksHtml += '</ul></div>';
                                        }
                                        
                                        // Performance metrics
                                        let perfHtml = '';
                                        if (vm.status === 'running') {
                                            perfHtml = '<div class="mt-2"><strong>Performance:</strong><ul class="mb-0">';
                                            if (vm.uptime) perfHtml += `<li>Uptime: ${formatUptime(vm.uptime)}</li>`;
                                            if (vm.cpu_usage !== null) perfHtml += `<li>CPU Usage: ${vm.cpu_usage.toFixed(1)}%</li>`;
                                            if (vm.mem_used) perfHtml += `<li>Memory Used: ${formatBytes(vm.mem_used)}</li>`;
                                            if (vm.netin) perfHtml += `<li>Network In: ${formatBytes(vm.netin)}</li>`;
                                            if (vm.netout) perfHtml += `<li>Network Out: ${formatBytes(vm.netout)}</li>`;
                                            if (vm.diskread) perfHtml += `<li>Disk Read: ${formatBytes(vm.diskread)}</li>`;
                                            if (vm.diskwrite) perfHtml += `<li>Disk Write: ${formatBytes(vm.diskwrite)}</li>`;
                                            perfHtml += '</ul></div>';
                                        }
                                        
                                        return `
                                        <tr>
                                            <td><code>${vm.vm_id}</code></td>
                                            <td>
                                                <strong>${vm.name}</strong>
                                                ${vm.bios || vm.machine ? `<br><small class="text-muted">${vm.bios || ''}${vm.bios && vm.machine ? ' / ' : ''}${vm.machine || ''}</small>` : ''}
                                            </td>
                                            <td><span class="badge bg-${vm.vm_type === 'lxc' ? 'info' : 'primary'}">${vm.vm_type || 'qemu'}</span></td>
                                            <td><span class="badge bg-${vm.status === 'running' ? 'success' : 'secondary'}">${vm.status || '-'}</span></td>
                                            <td>${cpuInfo}${cpuSockets}</td>
                                            <td>${vm.memory_mb ? (vm.memory_mb / 1024).toFixed(1) + ' GB' : '-'}</td>
                                            <td>${vm.disk_total_gb ? vm.disk_total_gb.toFixed(1) + ' GB' : '-'}
                                                ${vm.num_disks ? `<br><small class="text-muted">${vm.num_disks} dischi</small>` : ''}
                                            </td>
                                            <td><small>${vm.ip_addresses || '-'}</small></td>
                                            <td><small>${vm.os_type || '-'}</small></td>
                                            <td>${vm.agent_installed ? '<span class="badge bg-success" title="QEMU Guest Agent installato"><i class="bi bi-check-circle"></i></span>' : '<span class="badge bg-secondary" title="QEMU Guest Agent non installato"><i class="bi bi-x-circle"></i></span>'}</td>
                                        </tr>
                                        ${(disksHtml || networksHtml || perfHtml) ? `
                                        <tr class="table-light">
                                            <td colspan="10">
                                                <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#${vmDetailsId}" aria-expanded="false">
                                                    <i class="bi bi-chevron-down"></i> Dettagli
                                                </button>
                                                <div class="collapse mt-2" id="${vmDetailsId}">
                                                    ${disksHtml}${networksHtml}${perfHtml}
                                                </div>
                                            </td>
                                        </tr>
                                        ` : ''}
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            proxmoxHtml += `
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Nessuna VM trovata.
                    <br><small>I dati vengono raccolti automaticamente durante l'autodetect.</small>
                </div>
            `;
        }
        
        // Storage List
        if (storageData.success && storageData.storage && storageData.storage.length > 0) {
            proxmoxHtml += `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-hdd"></i> Storage (${storageData.count || storageData.storage.length})</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Totale</th>
                                        <th>Usato</th>
                                        <th>Disponibile</th>
                                        <th>Uso %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${storageData.storage.map(s => {
                                        const usagePercent = s.usage_percent || (s.total_gb && s.used_gb ? Math.round((s.used_gb / s.total_gb) * 100) : 0);
                                        const progressColor = usagePercent > 90 ? 'danger' : usagePercent > 75 ? 'warning' : 'success';
                                        return `
                                            <tr>
                                                <td><strong>${s.storage_name}</strong></td>
                                                <td><span class="badge bg-info">${s.storage_type || '-'}</span></td>
                                                <td>${s.total_gb ? s.total_gb.toFixed(1) + ' GB' : '-'}</td>
                                                <td>${s.used_gb ? s.used_gb.toFixed(1) + ' GB' : '-'}</td>
                                                <td>${s.available_gb ? s.available_gb.toFixed(1) + ' GB' : '-'}</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-${progressColor}" style="width: ${usagePercent}%">${usagePercent}%</div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            proxmoxHtml += `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Nessuno storage trovato.
                    <br><small>I dati vengono raccolti automaticamente durante l'autodetect.</small>
                </div>
            `;
        }
        
        content.innerHTML = proxmoxHtml;
        
    } catch (e) {
        content.innerHTML = `<div class="alert alert-danger">Errore: ${e.message}</div>`;
    }
}

async function refreshAdvancedDeviceInfo(deviceId) {
    if (!confirm('Aggiornare le informazioni avanzate per questo dispositivo?\\n\\nQuesta operazione pu√≤ richiedere alcuni secondi.')) {
        return;
    }
    
    const loadingToast = document.createElement('div');
    loadingToast.className = 'toast show position-fixed top-0 end-0 m-3';
    loadingToast.innerHTML = `
        <div class="toast-header">
            <strong class="me-auto">Refresh Info</strong>
            <div class="spinner-border spinner-border-sm me-2"></div>
        </div>
        <div class="toast-body">
            Aggiornamento informazioni avanzate in corso...
        </div>
    `;
    document.body.appendChild(loadingToast);
    
    try {
        const response = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/refresh-advanced-info`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            loadingToast.querySelector('.toast-body').innerHTML = '‚úÖ Informazioni avanzate aggiornate con successo!';
            setTimeout(() => {
                loadingToast.remove();
                // Ricarica la tab corrente se aperta
                const activeTab = document.querySelector('#deviceDetailTabs .nav-link.active');
                if (activeTab) {
                    const targetId = activeTab.getAttribute('data-bs-target');
                    if (targetId === '#neighbors') {
                        loadDeviceNeighbors(deviceId);
                    } else if (targetId === '#advanced-interfaces') {
                        loadDeviceAdvancedInterfaces(deviceId);
                    } else if (targetId === '#proxmox') {
                        loadProxmoxInfo(deviceId);
                    }
                }
            }, 2000);
        } else {
            throw new Error(result.message || 'Errore sconosciuto');
        }
    } catch (e) {
        loadingToast.querySelector('.toast-body').innerHTML = `‚ùå Errore: ${e.message}`;
        setTimeout(() => loadingToast.remove(), 3000);
    }
}

async function createVmInventoryDevices(deviceId) {
    if (!confirm('Creare dispositivi inventario per tutte le VM Proxmox che hanno IP?\n\nLe VM verranno aggiunte all\'inventario come dispositivi separati.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    try {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creazione...';
        btn.disabled = true;
        
        const response = await fetch(`/api/v1/inventory/${customerId}/devices/${deviceId}/proxmox/create-vm-devices`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Creati ${result.created} dispositivi inventario per VM Proxmox${result.skipped > 0 ? `\n${result.skipped} VM gi√† presenti nell'inventario` : ''}`);
            loadInventory(); // Ricarica la tabella inventario
            loadProxmoxInfo(deviceId); // Ricarica le info Proxmox per aggiornare il conteggio
        } else {
            alert('Errore: ' + (result.message || 'Creazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}
</script>
{% endblock %}
